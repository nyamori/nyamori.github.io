<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="https://nyamori.oss-cn-shanghai.aliyuncs.com/img/apple-touch-icon.png"><link rel="icon" href="https://nyamori.oss-cn-shanghai.aliyuncs.com/img/favicon-32x32.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Nyamori"><meta name="keywords" content=""><meta name="description" content="更新记录2022-04-28 第一次编辑 正文H.264H.264简介H.264是目前最为主流的视频编码标准，同时也是MPEG-4第十部分，一般称为H.264&#x2F;AVC。对比H.264以前广泛使用的视频编码，H.264提供更低的码率和更高的视频质量，同时也提供了更强的容错能力和良好的IP网络适应性。H.264编码在推出之后被视频点播和实时流媒体领域被广泛使用，在标准成立之初，H.264主要"><meta property="og:type" content="article"><meta property="og:title" content="x264学习笔记"><meta property="og:url" content="http://nyamori.icu/2022/04/28/x264%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html"><meta property="og:site_name" content="喵森"><meta property="og:description" content="更新记录2022-04-28 第一次编辑 正文H.264H.264简介H.264是目前最为主流的视频编码标准，同时也是MPEG-4第十部分，一般称为H.264&#x2F;AVC。对比H.264以前广泛使用的视频编码，H.264提供更低的码率和更高的视频质量，同时也提供了更强的容错能力和良好的IP网络适应性。H.264编码在推出之后被视频点播和实时流媒体领域被广泛使用，在标准成立之初，H.264主要"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-04-28T11:04:21.000Z"><meta property="article:modified_time" content="2022-04-28T11:17:38.184Z"><meta property="article:author" content="Nyamori"><meta property="article:tag" content="H.264"><meta property="article:tag" content="x264"><meta name="twitter:card" content="summary_large_image"><meta name="referrer" content="no-referrer-when-downgrade"><title>x264学习笔记 - 喵森</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"nyamori.icu",root:"/",version:"1.9.2",typing:{enable:!0,typeSpeed:50,cursorChar:"...",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.2.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Mementos</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="x264学习笔记"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-04-28 19:04" pubdate>2022年4月28日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i>44k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i>74 分钟</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">x264学习笔记</h1><div class="markdown-body"><h1 id="更新记录"><a href="#更新记录" class="headerlink" title="更新记录"></a>更新记录</h1><p>2022-04-28 第一次编辑</p><h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="H-264"><a href="#H-264" class="headerlink" title="H.264"></a>H.264</h2><h3 id="H-264简介"><a href="#H-264简介" class="headerlink" title="H.264简介"></a>H.264简介</h3><p>H.264是目前最为主流的视频编码标准，同时也是MPEG-4第十部分，一般称为H.264&#x2F;AVC。对比H.264以前广泛使用的视频编码，H.264提供更低的码率和更高的视频质量，同时也提供了更强的容错能力和良好的IP网络适应性。H.264编码在推出之后被视频点播和实时流媒体领域被广泛使用，在标准成立之初，H.264主要提供三个档次的流媒体能力：基本档次(baseline profile)，扩展档次(Extended profile)和主要档次(main profile)；其中，baseline profile被广泛应用于实时流媒体传输，例如视频会议，远程医疗等，提供低码率，低延时，高质量的流媒体视频流。</p><h3 id="图像质量PSNR"><a href="#图像质量PSNR" class="headerlink" title="图像质量PSNR"></a>图像质量PSNR</h3><p>PSNR即图像峰值信噪比(Peak Signal to Noise Ratio)，作为一种客观的图像质量评价标准，在图像处理相关的工程中被广泛使用，用于评价图像在经过压缩处理之后，获取到的处理图像的质量对比原始图像能否让人满意。其计算公式如下（其中，MSE是原图像与处理图像之间均方误差）：<br>$$<br>PSNR&#x3D;10*log_{10}(\frac {(2^n-1)^2}{MSE})<br>$$<br>作为一种客观图像质量评价方法，对比真实的主观图像质量评测，PSNR仍然存在一定误差。有时PSNR高的图像并不一定能够比PSNR低的图像带来更好的主观图像质量，这是因为人眼对图像质量误差的敏感度并非绝对相同，而是对部分特定场景敏感度更高。H.264基于大量实验数据利用人眼的敏感度进行了大量的优化。</p><h3 id="帧类型和参考帧"><a href="#帧类型和参考帧" class="headerlink" title="帧类型和参考帧"></a>帧类型和参考帧</h3><p>H.264编码中，图像存在不同的帧类型；一般可以分为IDR帧，I帧，P帧，B帧，还有SP&#x2F;SI等帧类型。同时，H.264还会产生SPS、PPS和SEI等NALU单元。下面简单介绍一下主要使用的帧类型(一些扩展类型这里不提)：</p><ol><li>IDR帧 Instantaneous Decoding Refresh 即时解码刷新帧，一定是一个I帧，解码器在接收到IDR帧时，会清空参考帧列表，并重置部分参数。IDR帧后的帧永远不会参考IDR帧前的帧。</li><li>I帧 Intra-coded picture 关键帧，只做帧内预测，只需要当帧画面即可解锁</li><li>P帧 Predictive-coded Picture 前向预测帧，会参考可以之前的参考帧进行帧间预测</li><li>B帧 Bidirectionally predicted picture双向预测帧，会参考前向和后向的参考帧进行帧间预测</li><li>SPS Sequence Parameter Set，序列参数集；包含profile，level，分辨率等重要信息，代表了一组编码序列的全局参数</li><li>PPS Picture Parameter Set，图像参数集，保持了图像编码时所使用的参数</li><li>SEI Supplementary Enhancement Information，图像增强信息，会携带一些自定义信息和对解码可能有帮助的信息</li></ol><h3 id="CABAC和CAVLC"><a href="#CABAC和CAVLC" class="headerlink" title="CABAC和CAVLC"></a>CABAC和CAVLC</h3><p>熵编码的两种方式，熵编码是一种无损压缩的方式。H.264在处理完图像数据之后，通过熵编码进一步提高了编码压缩率。其中CABAC为基于上下文的自适应二进制算数熵编码，CAVLC为基于上下文自适应的可变长编码。实时流媒体传输一般来说baseline profile，只支持CAVLC。</p><h3 id="视频码率控制"><a href="#视频码率控制" class="headerlink" title="视频码率控制"></a>视频码率控制</h3><p>图像是由一个一个的像素点组成，视频则又是由连续的图像组成，因此传输原始的无损图片会占用极大的带宽。视频编码的主要目的就在于，通过有损的压缩，在保证图像质量的同时尽可能的降低视频传输时占用的带宽，即视频码率。显然，视频的质量越高，视频的码率必然越高，进行码率控制，就是要求视频编码在质量和码率直接达到一定平衡。</p><h4 id="CBR-VS-VBR"><a href="#CBR-VS-VBR" class="headerlink" title="CBR VS VBR"></a>CBR VS VBR</h4><p>CBR即恒定码率控制(Constant Bitrate)，指定一个比特率，每一帧图像都按照这个比特数进行编码。这种编码方式在音频编码中非常常见，但是在视频编码领域，由于H.264当中不同帧类型要求的比特数本来就不同，同时不同的场景对于比特数的需求也不相同，复杂的场景显然需要更多的比特数，而简单固定的场景并不需要很多的比特数进行编码。导致固定码率，意味着对复杂的场景可能出现画质很差，对简单恒定的场景出现大量的比特浪费。</p><p>为了修正CBR存在的问题，视频编码就出现了VBR的码率控制方法，即可变码率控制(Variable Bitrate)，用于在给定比特限制下保持图像的最高质量。简单来说，VBR的核心思想在于，对于复杂的难编码的场景给予更多的比特，对于简单的易于编码的场景使用更少的比特，从而达成始终以较少的比特保持一定的图像质量。</p><p>可变比特率类型的码率控制方式在视频码率控制当中是主流方式。</p><h4 id="编码应用场景"><a href="#编码应用场景" class="headerlink" title="编码应用场景"></a>编码应用场景</h4><p>可变码率控制方式，对于不同的场景给予不同的比特数；同时，实际使用视频的场景也对视频的码率具有影响。不同的profile之间，由于启用的压缩技术不同，码率差距和编码速度也有区别。对于视频应用来说，一般有如下几种应用场景：</p><ol><li>视频存档：单纯的保存视频，不关心编码速度，最重要的指标是视频质量和视频大小，可以预知场景</li><li>流媒体点播：通过网络传输视频，不关心编码速度，在保证视频质量的时候视频码率不能超过带宽，尽量不占用带宽，可以预知场景</li><li>流媒体直播：通过网络传输实时视频，要求编码速度快，码率不超过带宽的情况下尽可能低，同时保证视频质量，不能预知场景</li><li>面向特定存储介质：将媒体刻录到DVD等介质上，要求编码出的视频大小刚好占满介质容量，并且质量高，可以预知场景</li></ol><p>不同的编码场景对视频指标的关注点不尽相同，其中流媒体直播即实时流媒体传输，对视频编码的要求更高。在实时流媒体传输当中，最重要的是保持流媒体的实时性，因此一般只采用baseline profile。同时，实时流媒体传输同样关注视频码率和视频质量，要求在码率足够小的同时质量足够好。并且，不能预知场景使得实时流媒体传输难以根据特定场景应用场景的优化参数。</p><h4 id="QP"><a href="#QP" class="headerlink" title="QP"></a>QP</h4><p>量化参数（Quantization Parameter,QP）控制着压缩大小。QP越大压缩率越高同时质量越低，QP越小压缩率越低同时质量越高。在H.264中，QP的范围是0-51间的整数。一般而言，控制码率就是控制编码的比特数，也即控制编码的QP值</p><p>TODO <a target="_blank" rel="noopener" href="https://www.vcodex.com/h264avc-4x4-transform-and-quantization/">QP的原理</a></p><h4 id="码率控制方式"><a href="#码率控制方式" class="headerlink" title="码率控制方式"></a>码率控制方式</h4><h5 id="CQP"><a href="#CQP" class="headerlink" title="CQP"></a>CQP</h5><p>恒定QP值（Constant QP）是通过保证每帧画面QP值固定进行码率控制的方法，可以发现，通过恒定QP完全无法控制码率，每帧画面编码出的大小完全受限于画面复杂度。因此，在x264文档中只推荐启用CQP用于研究，而不推荐使用CQP控制码率。</p><h5 id="ABR"><a href="#ABR" class="headerlink" title="ABR"></a>ABR</h5><p>平均码率控制模式(Average Bitrate)是通过控制整个码流的平均码率，从而控制码率的模式。ABR并不要求整个视频码率恒定，但是面对突发的过高码率，ABR会压低后续画面的码率以保持平均码率。因此，ABR虽然简单，但是由于在大部分场景中，编码器无法知道接下来的编码帧需要多大的码率，从而导致在画面变化时画面质量波动十分剧烈，使得视频质量低于预期。因此，在大多数情况都不应该使用ABR模式。</p><h5 id="2-PASS-ABR"><a href="#2-PASS-ABR" class="headerlink" title="2-PASS ABR"></a>2-PASS ABR</h5><p>ABR模式因为很难预测下一帧画面的消耗，往往导致码率控制效果很差。但是，如果允许编码器进行多次编码，编码器在第二次及之后的编码过程中就可以提前知道每一帧编码的消耗，从而更好的分配比特，这就是2-PASS ABR控制方式。在第一次编码时，编码器首先获得了视频编码的消耗，从而在第二次编码时更合理的分配，一般而言第二次编码会应用ABR码率控制，第一次编码CQP即可。</p><p>2-PASS编码能够在给定码率下达到较好质量，但是仍然存在一些问题。首先，如果给定的码率不足以保证图像质量，画面质量还是会低于预期，为了获得最好质量必须要有一个经验性的码率（需要多次实验）；其次，2-PASS码率控制进行两次编码，这对于实时流媒体来说基本是无法忍受的；最后，码率波动同样无法避免，如果瞬时码率过高，流媒体客户端的接受能力就必须纳入考虑。</p><h5 id="CRF"><a href="#CRF" class="headerlink" title="CRF"></a>CRF</h5><p>恒定视频质量( Constant Rate Factor)通过指定crf值，使编码器试图保证输出的图像质量恒定。crf值是一个类似于QP的概念，8bit的H.264编码的crf值理论范围是[0,51]，在x264中，默认的crf值为23。crf值每增长6，输出的视频码率就变为原来的1&#x2F;2，crf值和视频码率满足对数关系。在理论上，crf &#x3D; 0 即完全无损压缩，crf &#x3D; 51 即最大程度的压缩。在实际实践中，一般认为crf &#x3D; 18 即为H.264的无损画面，因此在主观图像质量评价中，crf值一般使用[18,28]作为范围，有时也会应用到17,29等边界值用于极端情况。</p><p>使用CRF进行码率控制，可以达到比较优质的图像质量，但是类似于CQP，CRF并不能对码率做出很好的保证。</p><h5 id="VBV"><a href="#VBV" class="headerlink" title="VBV"></a>VBV</h5><p>视频缓存验证(Video Buffering Verifier)通过设定视频流的码率上界和码率下界，保证媒体流既不会高于某个特定码率，也不会低于某个特定码率，从而完成码率的控制。使用VBV需要设置编码器的buffsize，一般设置为码率上界的两倍。</p><p>VBV的特性保证了在实时流媒体传输中，视频编码的码率总是被约束在接受方的能力范围内，因此在实时流媒体传输中被普遍使用，同时VBV实际上与2-PASS和CRF等控制方式兼容，因此可以做到结合使用。</p><h5 id="CRF-VBV"><a href="#CRF-VBV" class="headerlink" title="CRF + VBV"></a>CRF + VBV</h5><p>由于CRF和VBV完全兼容，因此可以同时启用这两个策略，在一定码率下保证画面的画质。</p><h4 id="各个码率控制方式对比总结"><a href="#各个码率控制方式对比总结" class="headerlink" title="各个码率控制方式对比总结"></a>各个码率控制方式对比总结</h4><table><thead><tr><th>控制方式</th><th>应用面</th><th>不适合的场景</th></tr></thead><tbody><tr><td>CQP</td><td>可以用于研究</td><td>几乎所有实际落地场景</td></tr><tr><td>ABR</td><td>要求简单快速</td><td>除非必须极低延时，几乎所有场景不应该使用</td></tr><tr><td>2-PASS ABR</td><td>面向特定场景，非实时的处理</td><td>要求低延时的场景，快速编码场景</td></tr><tr><td>CRF</td><td>对图像质量有要求的场景</td><td>对码率波动十分敏感的场景</td></tr><tr><td>VBV</td><td>实时流媒体，带宽受限的流媒体</td><td>存档类的编码</td></tr><tr><td>CRF + VBV</td><td>实时流媒体，带宽受限的流媒体</td><td>存档类的编码</td></tr></tbody></table><p>参考文档 <a target="_blank" rel="noopener" href="https://mailman.videolan.org/pipermail/x264-devel/2010-February/006934.html">[x264-devel] Making sense out of x264 rate control methods</a></p><h2 id="x264"><a href="#x264" class="headerlink" title="x264"></a>x264</h2><h3 id="x264代码框架"><a href="#x264代码框架" class="headerlink" title="x264代码框架"></a>x264代码框架</h3><p>文件组织如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs sh"> &gt; tree -L 1<br>.<br>├── AUTHORS<br>├── autocomplete.c<br>├── common //通用代码<br>├── config.guess<br>├── config.h<br>├── config.log<br>├── config.mak<br>├── config.sub<br>├── configure<br>├── COPYING<br>├── doc //文档<br>├── encoder //编码器代码<br>├── example.c //示例<br>├── extras <br>├── filters<br>├── input<br>├── Makefile<br>├── output //输出格式<br>├── tools<br>├── version.sh<br>├── x264.c<br>├── x264cli.h<br>├── x264_config.h<br>├── x264dll.c<br>├── x264.h<br>├── x264.pc<br>├── x264res.manifest<br>└── x264res.rc<br></code></pre></td></tr></table></figure><p>完整树如下（删减了git相关的文件）：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><code class="hljs sh">&gt; tree -a<br>.<br>├── AUTHORS<br>├── autocomplete.c<br>├── common<br>│   ├── aarch64<br>│   │   ├── asm-offsets.c<br>│   │   ├── asm-offsets.h<br>│   │   ├── asm.S<br>│   │   ├── bitstream-a.S<br>│   │   ├── bitstream.h<br>│   │   ├── cabac-a.S<br>│   │   ├── dct-a.S<br>│   │   ├── dct.h<br>│   │   ├── deblock-a.S<br>│   │   ├── deblock.h<br>│   │   ├── mc-a.S<br>│   │   ├── mc-c.c<br>│   │   ├── mc.h<br>│   │   ├── pixel-a.S<br>│   │   ├── pixel.h<br>│   │   ├── predict-a.S<br>│   │   ├── predict-c.c<br>│   │   ├── predict.h<br>│   │   ├── quant-a.S<br>│   │   └── quant.h<br>│   ├── arm<br>│   │   ├── asm.S<br>│   │   ├── bitstream-a.S<br>│   │   ├── bitstream.h<br>│   │   ├── cpu-a.S<br>│   │   ├── dct-a.S<br>│   │   ├── dct.h<br>│   │   ├── deblock-a.S<br>│   │   ├── deblock.h<br>│   │   ├── mc-a.S<br>│   │   ├── mc-c.c<br>│   │   ├── mc.h<br>│   │   ├── pixel-a.S<br>│   │   ├── pixel.h<br>│   │   ├── predict-a.S<br>│   │   ├── predict-c.c<br>│   │   ├── predict.h<br>│   │   ├── quant-a.S<br>│   │   └── quant.h<br>│   ├── base.c<br>│   ├── base.h<br>│   ├── bitstream.c<br>│   ├── bitstream.h<br>│   ├── cabac.c<br>│   ├── cabac.h<br>│   ├── common.c<br>│   ├── common.h<br>│   ├── cpu.c<br>│   ├── cpu.h<br>│   ├── dct.c<br>│   ├── dct.h<br>│   ├── deblock.c<br>│   ├── frame.c<br>│   ├── frame.h<br>│   ├── macroblock.c<br>│   ├── macroblock.h<br>│   ├── mc.c<br>│   ├── mc.h<br>│   ├── mips<br>│   │   ├── dct-c.c<br>│   │   ├── dct.h<br>│   │   ├── deblock-c.c<br>│   │   ├── deblock.h<br>│   │   ├── macros.h<br>│   │   ├── mc-c.c<br>│   │   ├── mc.h<br>│   │   ├── pixel-c.c<br>│   │   ├── pixel.h<br>│   │   ├── predict-c.c<br>│   │   ├── predict.h<br>│   │   ├── quant-c.c<br>│   │   └── quant.h<br>│   ├── mvpred.c<br>│   ├── opencl<br>│   │   ├── bidir.cl<br>│   │   ├── downscale.cl<br>│   │   ├── intra.cl<br>│   │   ├── motionsearch.cl<br>│   │   ├── subpel.cl<br>│   │   ├── weightp.cl<br>│   │   └── x264-cl.h<br>│   ├── opencl.c<br>│   ├── opencl.h<br>│   ├── osdep.c<br>│   ├── osdep.h<br>│   ├── pixel.c<br>│   ├── pixel.h<br>│   ├── ppc<br>│   │   ├── dct.c<br>│   │   ├── dct.h<br>│   │   ├── deblock.c<br>│   │   ├── deblock.h<br>│   │   ├── mc.c<br>│   │   ├── mc.h<br>│   │   ├── pixel.c<br>│   │   ├── pixel.h<br>│   │   ├── ppccommon.h<br>│   │   ├── predict.c<br>│   │   ├── predict.h<br>│   │   ├── quant.c<br>│   │   └── quant.h<br>│   ├── predict.c<br>│   ├── predict.h<br>│   ├── quant.c<br>│   ├── quant.h<br>│   ├── rectangle.c<br>│   ├── rectangle.h<br>│   ├── set.c<br>│   ├── set.h<br>│   ├── tables.c<br>│   ├── tables.h<br>│   ├── threadpool.c<br>│   ├── threadpool.h<br>│   ├── vlc.c<br>│   ├── win32thread.c<br>│   ├── win32thread.h<br>│   └── x86<br>│       ├── bitstream-a.asm<br>│       ├── bitstream.h<br>│       ├── cabac-a.asm<br>│       ├── const-a.asm<br>│       ├── cpu-a.asm<br>│       ├── dct-32.asm<br>│       ├── dct-64.asm<br>│       ├── dct-a.asm<br>│       ├── dct.h<br>│       ├── deblock-a.asm<br>│       ├── deblock.h<br>│       ├── mc-a2.asm<br>│       ├── mc-a.asm<br>│       ├── mc-c.c<br>│       ├── mc.h<br>│       ├── pixel-32.asm<br>│       ├── pixel-a.asm<br>│       ├── pixel.h<br>│       ├── predict-a.asm<br>│       ├── predict-c.c<br>│       ├── predict.h<br>│       ├── quant-a.asm<br>│       ├── quant.h<br>│       ├── sad16-a.asm<br>│       ├── sad-a.asm<br>│       ├── trellis-64.asm<br>│       ├── util.h<br>│       ├── x86inc.asm<br>│       └── x86util.asm<br>├── config.guess<br>├── config.h<br>├── config.log<br>├── config.mak<br>├── config.sub<br>├── configure<br>├── COPYING<br>├── doc<br>│   ├── ratecontrol.txt<br>│   ├── regression_test.txt<br>│   ├── standards.txt<br>│   ├── threads.txt<br>│   └── vui.txt<br>├── encoder<br>│   ├── analyse.c<br>│   ├── analyse.h<br>│   ├── api.c<br>│   ├── cabac.c<br>│   ├── cavlc.c<br>│   ├── encoder.c<br>│   ├── lookahead.c<br>│   ├── macroblock.c<br>│   ├── macroblock.h<br>│   ├── me.c<br>│   ├── me.h<br>│   ├── ratecontrol.c<br>│   ├── ratecontrol.h<br>│   ├── rdo.c<br>│   ├── set.c<br>│   ├── set.h<br>│   ├── slicetype.c<br>│   ├── slicetype-cl.c<br>│   └── slicetype-cl.h<br>├── example.c<br>├── extras<br>│   ├── avisynth_c.h<br>│   ├── avxsynth_c.h<br>│   ├── cl.h<br>│   ├── cl_platform.h<br>│   ├── getopt.c<br>│   ├── getopt.h<br>│   ├── intel_dispatcher.h<br>│   ├── inttypes.h<br>│   └── stdint.h<br>├── filters<br>│   ├── filters.c<br>│   ├── filters.h<br>│   └── video<br>│       ├── cache.c<br>│       ├── crop.c<br>│       ├── depth.c<br>│       ├── fix_vfr_pts.c<br>│       ├── internal.c<br>│       ├── internal.h<br>│       ├── resize.c<br>│       ├── select_every.c<br>│       ├── source.c<br>│       ├── video.c<br>│       └── video.h<br>├── input<br>│   ├── avs.c<br>│   ├── ffms.c<br>│   ├── input.c<br>│   ├── input.h<br>│   ├── lavf.c<br>│   ├── raw.c<br>│   ├── thread.c<br>│   ├── timecode.c<br>│   └── y4m.c<br>├── Makefile<br>├── output<br>│   ├── flv_bytestream.c<br>│   ├── flv_bytestream.h<br>│   ├── flv.c<br>│   ├── matroska.c<br>│   ├── matroska_ebml.c<br>│   ├── matroska_ebml.h<br>│   ├── mp4.c<br>│   ├── mp4_lsmash.c<br>│   ├── output.h<br>│   └── raw.c<br>├── tools<br>│   ├── bash-autocomplete.sh<br>│   ├── checkasm-aarch64.S<br>│   ├── checkasm-a.asm<br>│   ├── checkasm-arm.S<br>│   ├── checkasm.c<br>│   ├── cltostr.sh<br>│   ├── countquant_x264.pl<br>│   ├── digress<br>│   │   ├── cli.py<br>│   │   ├── comparers.py<br>│   │   ├── constants.py<br>│   │   ├── errors.py<br>│   │   ├── __init__.py<br>│   │   ├── scm<br>│   │   │   ├── dummy.py<br>│   │   │   ├── git.py<br>│   │   │   └── __init__.py<br>│   │   └── testing.py<br>│   ├── gas-preprocessor.pl<br>│   ├── msvsdepend.sh<br>│   ├── q_matrix_jvt.cfg<br>│   └── test_x264.py<br>├── version.sh<br>├── x264.c <br>├── x264cli.h<br>├── x264_config.h<br>├── x264dll.c<br>├── x264.h<br>├── x264.pc<br>├── x264res.manifest<br>└── x264res.rc<br></code></pre></td></tr></table></figure><h4 id="代码框架分析"><a href="#代码框架分析" class="headerlink" title="代码框架分析"></a>代码框架分析</h4><p>TODO</p><h3 id="x264代码分析"><a href="#x264代码分析" class="headerlink" title="x264代码分析"></a>x264代码分析</h3><p>在编译完成之后，x264分为可执行程序x264和库libx264。先从可执行程序x264看起，了解大概流程。</p><h4 id="整体调用分析"><a href="#整体调用分析" class="headerlink" title="整体调用分析"></a>整体调用分析</h4><div align="center"><text>x264调用流程</text><img src="https://nyamori.oss-cn-shanghai.aliyuncs.com/img/x264调用流程.png" srcset="/img/loading.gif" lazyload width="100%" height="100%" style="border:0;box-shadow:none"></div><p>注：图中橙色函数为实际调用需要的x264 API，红色函数为目前认为和码率控制有关的函数，绿色为注释</p><h4 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h4><p>x264.c中定义了x264的main函数，这个函数处理命令行参数，设置信号；然后进行编码处理和完成后的清理工作。在该函数中，主要的核心函数为prase()和encode()，核心结构体为x264_param_t和cli_opt_t，如下所示:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c">REALIGN_STACK <span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">( <span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv )</span><br>&#123;<br>    <span class="hljs-keyword">if</span>( argc == <span class="hljs-number">4</span> &amp;&amp; !<span class="hljs-built_in">strcmp</span>( argv[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;--autocomplete&quot;</span> ) )<br>        <span class="hljs-keyword">return</span> x264_cli_autocomplete( argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>] );<br><br>    <span class="hljs-type">x264_param_t</span> param; <span class="hljs-comment">//x264对外提供的参数，定义在x264.h中</span><br>    <span class="hljs-type">cli_opt_t</span> opt = &#123;<span class="hljs-number">0</span>&#125;; <span class="hljs-comment">//cli参数，定义在x264.c中</span><br>    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><br>    FAIL_IF_ERROR( x264_threading_init(), <span class="hljs-string">&quot;unable to initialize threading\n&quot;</span> );<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _WIN32</span><br>    FAIL_IF_ERROR( !get_argv_utf8( &amp;argc, &amp;argv ), <span class="hljs-string">&quot;unable to convert command line to UTF-8\n&quot;</span> );<br><br>    GetConsoleTitleW( org_console_title, CONSOLE_TITLE_SIZE );<br>    _setmode( _fileno( <span class="hljs-built_in">stdin</span> ),  _O_BINARY );<br>    _setmode( _fileno( <span class="hljs-built_in">stdout</span> ), _O_BINARY );<br>    _setmode( _fileno( <span class="hljs-built_in">stderr</span> ), _O_BINARY );<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">// 此处对命令行参数进行解析，初始化x264参数</span><br>    x264_param_default( &amp;param );<br>    <span class="hljs-comment">/* Parse command line */</span><br>    <span class="hljs-keyword">if</span>( parse( argc, argv, &amp;param, &amp;opt ) &lt; <span class="hljs-number">0</span> )<br>        ret = <span class="hljs-number">-1</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _WIN32</span><br>    <span class="hljs-comment">/* Restore title; it can be changed by input modules */</span><br>    SetConsoleTitleW( org_console_title );<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">/* Control-C handler */</span><br>    signal( SIGINT, sigint_handler );<br><br>    <span class="hljs-comment">//编码操作</span><br>    <span class="hljs-keyword">if</span>( !ret )<br>        ret = encode( &amp;param, &amp;opt );<br><br>    <span class="hljs-comment">/* clean up handles */</span><br>    <span class="hljs-keyword">if</span>( filter.<span class="hljs-built_in">free</span> )<br>        filter.<span class="hljs-built_in">free</span>( opt.hin );<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( opt.hin )<br>        cli_input.close_file( opt.hin );<br>    <span class="hljs-keyword">if</span>( opt.hout )<br>        cli_output.close_file( opt.hout, <span class="hljs-number">0</span>, <span class="hljs-number">0</span> );<br>    <span class="hljs-keyword">if</span>( opt.tcfile_out )<br>        fclose( opt.tcfile_out );<br>    <span class="hljs-keyword">if</span>( opt.qpfile )<br>        fclose( opt.qpfile );<br>    x264_param_cleanup( &amp;param );<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _WIN32</span><br>    SetConsoleTitleW( org_console_title );<br>    <span class="hljs-built_in">free</span>( argv );<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>继续分析两个关键函数</p><h4 id="parse-argc-argv-amp-param-amp-opt"><a href="#parse-argc-argv-amp-param-amp-opt" class="headerlink" title="parse( argc, argv, &amp;param, &amp;opt )"></a>parse( argc, argv, &amp;param, &amp;opt )</h4><p>prase函数用于解析命令行参数，并对x264_param_t进行初始化。prase主要调用了以下函数(位于common&#x2F;base.c)进行设置设置：</p><ol><li>x264_param_default_preset - 根据preset和tune设置参数</li><li>x264_param_default - 设置默认参数</li><li>x264_param_parse - 解析用户自带的参数</li><li>x264_param_apply_profile - 设置profile</li></ol><h5 id="x264-param-default-common-x2F-base-c"><a href="#x264-param-default-common-x2F-base-c" class="headerlink" title="x264_param_default(common&#x2F;base.c)"></a>x264_param_default(common&#x2F;base.c)</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/****************************************************************************</span><br><span class="hljs-comment"> * x264_param_default:初始化默认参数，因此会设置全部参数的默认值</span><br><span class="hljs-comment"> ****************************************************************************/</span><br>REALIGN_STACK <span class="hljs-type">void</span> <span class="hljs-title function_">x264_param_default</span><span class="hljs-params">( <span class="hljs-type">x264_param_t</span> *param )</span><br>&#123;<br>    <span class="hljs-built_in">memset</span>( param, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>( <span class="hljs-type">x264_param_t</span> ) );<br><br>    <span class="hljs-comment">/* CPU autodetect */</span><br>    param-&gt;cpu = x264_cpu_detect();<br>    param-&gt;i_threads = X264_THREADS_AUTO;<br>    param-&gt;i_lookahead_threads = X264_THREADS_AUTO;<br>    param-&gt;b_deterministic = <span class="hljs-number">1</span>;<br>    param-&gt;i_sync_lookahead = X264_SYNC_LOOKAHEAD_AUTO;<br><br>    <span class="hljs-comment">/* Video properties */</span><br>    param-&gt;i_csp           = X264_CHROMA_FORMAT ? X264_CHROMA_FORMAT : X264_CSP_I420;<br>    param-&gt;i_width         = <span class="hljs-number">0</span>;<br>    param-&gt;i_height        = <span class="hljs-number">0</span>;<br>    param-&gt;vui.i_sar_width = <span class="hljs-number">0</span>;<br>    param-&gt;vui.i_sar_height= <span class="hljs-number">0</span>;<br>    param-&gt;vui.i_overscan  = <span class="hljs-number">0</span>;  <span class="hljs-comment">/* undef */</span><br>    param-&gt;vui.i_vidformat = <span class="hljs-number">5</span>;  <span class="hljs-comment">/* undef */</span><br>    param-&gt;vui.b_fullrange = <span class="hljs-number">-1</span>; <span class="hljs-comment">/* default depends on input */</span><br>    param-&gt;vui.i_colorprim = <span class="hljs-number">2</span>;  <span class="hljs-comment">/* undef */</span><br>    param-&gt;vui.i_transfer  = <span class="hljs-number">2</span>;  <span class="hljs-comment">/* undef */</span><br>    param-&gt;vui.i_colmatrix = <span class="hljs-number">-1</span>; <span class="hljs-comment">/* default depends on input */</span><br>    param-&gt;vui.i_chroma_loc= <span class="hljs-number">0</span>;  <span class="hljs-comment">/* left center */</span><br>    param-&gt;i_fps_num       = <span class="hljs-number">25</span>;<br>    param-&gt;i_fps_den       = <span class="hljs-number">1</span>;<br>    param-&gt;i_level_idc     = <span class="hljs-number">-1</span>;<br>    param-&gt;i_slice_max_size = <span class="hljs-number">0</span>;<br>    param-&gt;i_slice_max_mbs = <span class="hljs-number">0</span>;<br>    param-&gt;i_slice_count = <span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> HAVE_BITDEPTH8</span><br>    param-&gt;i_bitdepth = <span class="hljs-number">8</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">elif</span> HAVE_BITDEPTH10</span><br>    param-&gt;i_bitdepth = <span class="hljs-number">10</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    param-&gt;i_bitdepth = <span class="hljs-number">8</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">/* Encoder parameters */</span><br>    param-&gt;i_frame_reference = <span class="hljs-number">3</span>;<br>    param-&gt;i_keyint_max = <span class="hljs-number">250</span>;<br>    param-&gt;i_keyint_min = X264_KEYINT_MIN_AUTO;<br>    param-&gt;i_bframe = <span class="hljs-number">3</span>;<br>    param-&gt;i_scenecut_threshold = <span class="hljs-number">40</span>;<br>    param-&gt;i_bframe_adaptive = X264_B_ADAPT_FAST;<br>    param-&gt;i_bframe_bias = <span class="hljs-number">0</span>;<br>    param-&gt;i_bframe_pyramid = X264_B_PYRAMID_NORMAL;<br>    param-&gt;b_interlaced = <span class="hljs-number">0</span>;<br>    param-&gt;b_constrained_intra = <span class="hljs-number">0</span>;<br><br>    param-&gt;b_deblocking_filter = <span class="hljs-number">1</span>;<br>    param-&gt;i_deblocking_filter_alphac0 = <span class="hljs-number">0</span>;<br>    param-&gt;i_deblocking_filter_beta = <span class="hljs-number">0</span>;<br><br>    param-&gt;b_cabac = <span class="hljs-number">1</span>;<br>    param-&gt;i_cabac_init_idc = <span class="hljs-number">0</span>;<br>	<span class="hljs-comment">//以下为码率控制参数</span><br>    param-&gt;rc.i_rc_method = X264_RC_CRF;<span class="hljs-comment">//默认crf</span><br>    param-&gt;rc.i_bitrate = <span class="hljs-number">0</span>;<br>    param-&gt;rc.f_rate_tolerance = <span class="hljs-number">1.0</span>;<br>    param-&gt;rc.i_vbv_max_bitrate = <span class="hljs-number">0</span>;<br>    param-&gt;rc.i_vbv_buffer_size = <span class="hljs-number">0</span>;<br>    param-&gt;rc.f_vbv_buffer_init = <span class="hljs-number">0.9</span>;<br>    param-&gt;rc.i_qp_constant = <span class="hljs-number">-1</span>;<br>    param-&gt;rc.f_rf_constant = <span class="hljs-number">23</span>;<br>    param-&gt;rc.i_qp_min = <span class="hljs-number">0</span>;<br>    param-&gt;rc.i_qp_max = INT_MAX;<br>    param-&gt;rc.i_qp_step = <span class="hljs-number">4</span>;<br>    param-&gt;rc.f_ip_factor = <span class="hljs-number">1.4</span>;<br>    param-&gt;rc.f_pb_factor = <span class="hljs-number">1.3</span>;<br>    param-&gt;rc.i_aq_mode = X264_AQ_VARIANCE;<br>    param-&gt;rc.f_aq_strength = <span class="hljs-number">1.0</span>;<br>    param-&gt;rc.i_lookahead = <span class="hljs-number">40</span>;<br><br>    param-&gt;rc.b_stat_write = <span class="hljs-number">0</span>;<br>    param-&gt;rc.psz_stat_out = <span class="hljs-string">&quot;x264_2pass.log&quot;</span>;<br>    param-&gt;rc.b_stat_read = <span class="hljs-number">0</span>;<br>    param-&gt;rc.psz_stat_in = <span class="hljs-string">&quot;x264_2pass.log&quot;</span>;<br>    param-&gt;rc.f_qcompress = <span class="hljs-number">0.6</span>;<br>    param-&gt;rc.f_qblur = <span class="hljs-number">0.5</span>;<br>    param-&gt;rc.f_complexity_blur = <span class="hljs-number">20</span>;<br>    param-&gt;rc.i_zones = <span class="hljs-number">0</span>;<br>    param-&gt;rc.b_mb_tree = <span class="hljs-number">1</span>;<br>   <br>    <span class="hljs-comment">/* Log */</span><br>    param-&gt;pf_log = x264_log_default;<br>    param-&gt;p_log_private = <span class="hljs-literal">NULL</span>;<br>    param-&gt;i_log_level = X264_LOG_INFO;<br><br>    <span class="hljs-comment">/*analysis相关 */</span><br>    param-&gt;analyse.intra = X264_ANALYSE_I4x4 | X264_ANALYSE_I8x8;<br>    param-&gt;analyse.inter = X264_ANALYSE_I4x4 | X264_ANALYSE_I8x8<br>                         | X264_ANALYSE_PSUB16x16 | X264_ANALYSE_BSUB16x16;<br>    param-&gt;analyse.i_direct_mv_pred = X264_DIRECT_PRED_SPATIAL;<br>    param-&gt;analyse.i_me_method = X264_ME_HEX; <span class="hljs-comment">//六边形搜索</span><br>    param-&gt;analyse.f_psy_rd = <span class="hljs-number">1.0</span>;<br>    param-&gt;analyse.b_psy = <span class="hljs-number">1</span>;<br>    param-&gt;analyse.f_psy_trellis = <span class="hljs-number">0</span>;<br>    param-&gt;analyse.i_me_range = <span class="hljs-number">16</span>;<br>    param-&gt;analyse.i_subpel_refine = <span class="hljs-number">7</span>;<br>    param-&gt;analyse.b_mixed_references = <span class="hljs-number">1</span>;<br>    param-&gt;analyse.b_chroma_me = <span class="hljs-number">1</span>;<br>    param-&gt;analyse.i_mv_range_thread = <span class="hljs-number">-1</span>;<br>    param-&gt;analyse.i_mv_range = <span class="hljs-number">-1</span>; <span class="hljs-comment">// set from level_idc</span><br>    param-&gt;analyse.i_chroma_qp_offset = <span class="hljs-number">0</span>;<br>    param-&gt;analyse.b_fast_pskip = <span class="hljs-number">1</span>;<br>    param-&gt;analyse.b_weighted_bipred = <span class="hljs-number">1</span>;<br>    param-&gt;analyse.i_weighted_pred = X264_WEIGHTP_SMART;<br>    param-&gt;analyse.b_dct_decimate = <span class="hljs-number">1</span>;<br>    param-&gt;analyse.b_transform_8x8 = <span class="hljs-number">1</span>;<br>    param-&gt;analyse.i_trellis = <span class="hljs-number">1</span>;<br>    param-&gt;analyse.i_luma_deadzone[<span class="hljs-number">0</span>] = <span class="hljs-number">21</span>;<br>    param-&gt;analyse.i_luma_deadzone[<span class="hljs-number">1</span>] = <span class="hljs-number">11</span>;<br>    param-&gt;analyse.b_psnr = <span class="hljs-number">0</span>;<br>    param-&gt;analyse.b_ssim = <span class="hljs-number">0</span>;<br><br>    param-&gt;i_cqm_preset = X264_CQM_FLAT;<br>    <span class="hljs-built_in">memset</span>( param-&gt;cqm_4iy, <span class="hljs-number">16</span>, <span class="hljs-keyword">sizeof</span>( param-&gt;cqm_4iy ) );<br>    <span class="hljs-built_in">memset</span>( param-&gt;cqm_4py, <span class="hljs-number">16</span>, <span class="hljs-keyword">sizeof</span>( param-&gt;cqm_4py ) );<br>    <span class="hljs-built_in">memset</span>( param-&gt;cqm_4ic, <span class="hljs-number">16</span>, <span class="hljs-keyword">sizeof</span>( param-&gt;cqm_4ic ) );<br>    <span class="hljs-built_in">memset</span>( param-&gt;cqm_4pc, <span class="hljs-number">16</span>, <span class="hljs-keyword">sizeof</span>( param-&gt;cqm_4pc ) );<br>    <span class="hljs-built_in">memset</span>( param-&gt;cqm_8iy, <span class="hljs-number">16</span>, <span class="hljs-keyword">sizeof</span>( param-&gt;cqm_8iy ) );<br>    <span class="hljs-built_in">memset</span>( param-&gt;cqm_8py, <span class="hljs-number">16</span>, <span class="hljs-keyword">sizeof</span>( param-&gt;cqm_8py ) );<br>    <span class="hljs-built_in">memset</span>( param-&gt;cqm_8ic, <span class="hljs-number">16</span>, <span class="hljs-keyword">sizeof</span>( param-&gt;cqm_8ic ) );<br>    <span class="hljs-built_in">memset</span>( param-&gt;cqm_8pc, <span class="hljs-number">16</span>, <span class="hljs-keyword">sizeof</span>( param-&gt;cqm_8pc ) );<br><br>    param-&gt;b_repeat_headers = <span class="hljs-number">1</span>;<br>    param-&gt;b_annexb = <span class="hljs-number">1</span>;<br>    param-&gt;b_aud = <span class="hljs-number">0</span>;<br>    param-&gt;b_vfr_input = <span class="hljs-number">1</span>;<br>    param-&gt;i_nal_hrd = X264_NAL_HRD_NONE;<br>    param-&gt;b_tff = <span class="hljs-number">1</span>;<br>    param-&gt;b_pic_struct = <span class="hljs-number">0</span>;<br>    param-&gt;b_fake_interlaced = <span class="hljs-number">0</span>;<br>    param-&gt;i_frame_packing = <span class="hljs-number">-1</span>;<br>    param-&gt;i_alternative_transfer = <span class="hljs-number">2</span>; <span class="hljs-comment">/* undef */</span><br>    param-&gt;b_opencl = <span class="hljs-number">0</span>;<br>    param-&gt;i_opencl_device = <span class="hljs-number">0</span>;<br>    param-&gt;opencl_device_id = <span class="hljs-literal">NULL</span>;<br>    param-&gt;psz_clbin_file = <span class="hljs-literal">NULL</span>;<br>    param-&gt;i_avcintra_class = <span class="hljs-number">0</span>;<br>    param-&gt;i_avcintra_flavor = X264_AVCINTRA_FLAVOR_PANASONIC;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="x264-param-default-preset-common-x2F-base-c"><a href="#x264-param-default-preset-common-x2F-base-c" class="headerlink" title="x264_param_default_preset(common&#x2F;base.c)"></a>x264_param_default_preset(common&#x2F;base.c)</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//设置x264默认的preset和tune</span><br>REALIGN_STACK <span class="hljs-type">int</span> <span class="hljs-title function_">x264_param_default_preset</span><span class="hljs-params">( <span class="hljs-type">x264_param_t</span> *param, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *preset, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *tune )</span><br>&#123;<br>    <span class="hljs-comment">//这里又一次把参数设置到了默认值</span><br>    x264_param_default( param );<br><br>    <span class="hljs-keyword">if</span>( preset &amp;&amp; param_apply_preset( param, preset ) &lt; <span class="hljs-number">0</span> )<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">if</span>( tune &amp;&amp; param_apply_tune( param, tune ) &lt; <span class="hljs-number">0</span> )<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//根据输入的preset设置部分参数</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">param_apply_preset</span><span class="hljs-params">( <span class="hljs-type">x264_param_t</span> *param, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *preset )</span><br>&#123;<br>    <span class="hljs-type">char</span> *end;<br>    <span class="hljs-type">int</span> i = strtol( preset, &amp;end, <span class="hljs-number">10</span> );<br>    <span class="hljs-keyword">if</span>( *end == <span class="hljs-number">0</span> &amp;&amp; i &gt;= <span class="hljs-number">0</span> &amp;&amp; i &lt; ARRAY_ELEMS(x264_preset_names)<span class="hljs-number">-1</span> )<br>        preset = x264_preset_names[i];<br><br>    <span class="hljs-keyword">if</span>( !strcasecmp( preset, <span class="hljs-string">&quot;ultrafast&quot;</span> ) )<br>    &#123;<br>        param-&gt;i_frame_reference = <span class="hljs-number">1</span>;<br>        param-&gt;i_scenecut_threshold = <span class="hljs-number">0</span>;<br>        param-&gt;b_deblocking_filter = <span class="hljs-number">0</span>; <span class="hljs-comment">//关闭了去方块滤波</span><br>        param-&gt;b_cabac = <span class="hljs-number">0</span>;<br>        param-&gt;i_bframe = <span class="hljs-number">0</span>; <span class="hljs-comment">//无b帧</span><br>        param-&gt;analyse.intra = <span class="hljs-number">0</span>;<br>        param-&gt;analyse.inter = <span class="hljs-number">0</span>;<br>        param-&gt;analyse.b_transform_8x8 = <span class="hljs-number">0</span>; <span class="hljs-comment">//无8x8 DCT</span><br>        param-&gt;analyse.i_me_method = X264_ME_DIA; <span class="hljs-comment">//菱形搜索</span><br>        param-&gt;analyse.i_subpel_refine = <span class="hljs-number">0</span>;<br>        param-&gt;rc.i_aq_mode = <span class="hljs-number">0</span>;<br>        param-&gt;analyse.b_mixed_references = <span class="hljs-number">0</span>;<br>        param-&gt;analyse.i_trellis = <span class="hljs-number">0</span>;<br>        param-&gt;i_bframe_adaptive = X264_B_ADAPT_NONE;<br>        param-&gt;rc.b_mb_tree = <span class="hljs-number">0</span>;<br>        param-&gt;analyse.i_weighted_pred = X264_WEIGHTP_NONE;<br>        param-&gt;analyse.b_weighted_bipred = <span class="hljs-number">0</span>;<br>        param-&gt;rc.i_lookahead = <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( !strcasecmp( preset, <span class="hljs-string">&quot;superfast&quot;</span> ) )<br>    &#123;<br>        param-&gt;analyse.inter = X264_ANALYSE_I8x8|X264_ANALYSE_I4x4;<br>        param-&gt;analyse.i_me_method = X264_ME_DIA;<br>        param-&gt;analyse.i_subpel_refine = <span class="hljs-number">1</span>;<br>        param-&gt;i_frame_reference = <span class="hljs-number">1</span>;<br>        param-&gt;analyse.b_mixed_references = <span class="hljs-number">0</span>;<br>        param-&gt;analyse.i_trellis = <span class="hljs-number">0</span>;<br>        param-&gt;rc.b_mb_tree = <span class="hljs-number">0</span>;<br>        param-&gt;analyse.i_weighted_pred = X264_WEIGHTP_SIMPLE;<br>        param-&gt;rc.i_lookahead = <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( !strcasecmp( preset, <span class="hljs-string">&quot;veryfast&quot;</span> ) )<br>    &#123;<br>        param-&gt;analyse.i_subpel_refine = <span class="hljs-number">2</span>;<br>        param-&gt;i_frame_reference = <span class="hljs-number">1</span>;<br>        param-&gt;analyse.b_mixed_references = <span class="hljs-number">0</span>;<br>        param-&gt;analyse.i_trellis = <span class="hljs-number">0</span>;<br>        param-&gt;analyse.i_weighted_pred = X264_WEIGHTP_SIMPLE;<br>        param-&gt;rc.i_lookahead = <span class="hljs-number">10</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( !strcasecmp( preset, <span class="hljs-string">&quot;faster&quot;</span> ) )<br>    &#123;<br>        param-&gt;analyse.b_mixed_references = <span class="hljs-number">0</span>;<br>        param-&gt;i_frame_reference = <span class="hljs-number">2</span>;<br>        param-&gt;analyse.i_subpel_refine = <span class="hljs-number">4</span>;<br>        param-&gt;analyse.i_weighted_pred = X264_WEIGHTP_SIMPLE;<br>        param-&gt;rc.i_lookahead = <span class="hljs-number">20</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( !strcasecmp( preset, <span class="hljs-string">&quot;fast&quot;</span> ) )<br>    &#123;<br>        param-&gt;i_frame_reference = <span class="hljs-number">2</span>;<br>        param-&gt;analyse.i_subpel_refine = <span class="hljs-number">6</span>;<br>        param-&gt;analyse.i_weighted_pred = X264_WEIGHTP_SIMPLE;<br>        param-&gt;rc.i_lookahead = <span class="hljs-number">30</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( !strcasecmp( preset, <span class="hljs-string">&quot;medium&quot;</span> ) )<br>    &#123;<br>        <span class="hljs-comment">/* Default is medium */</span><br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( !strcasecmp( preset, <span class="hljs-string">&quot;slow&quot;</span> ) )<br>    &#123;<br>        param-&gt;analyse.i_subpel_refine = <span class="hljs-number">8</span>;<br>        param-&gt;i_frame_reference = <span class="hljs-number">5</span>;<br>        param-&gt;analyse.i_direct_mv_pred = X264_DIRECT_PRED_AUTO;<br>        param-&gt;analyse.i_trellis = <span class="hljs-number">2</span>;<br>        param-&gt;rc.i_lookahead = <span class="hljs-number">50</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( !strcasecmp( preset, <span class="hljs-string">&quot;slower&quot;</span> ) )<br>    &#123;<br>        param-&gt;analyse.i_me_method = X264_ME_UMH; <span class="hljs-comment">//非对称十字六边形网络搜索</span><br>        param-&gt;analyse.i_subpel_refine = <span class="hljs-number">9</span>;<br>        param-&gt;i_frame_reference = <span class="hljs-number">8</span>;<br>        param-&gt;i_bframe_adaptive = X264_B_ADAPT_TRELLIS;<br>        param-&gt;analyse.i_direct_mv_pred = X264_DIRECT_PRED_AUTO;<br>        param-&gt;analyse.inter |= X264_ANALYSE_PSUB8x8;<br>        param-&gt;analyse.i_trellis = <span class="hljs-number">2</span>;<br>        param-&gt;rc.i_lookahead = <span class="hljs-number">60</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( !strcasecmp( preset, <span class="hljs-string">&quot;veryslow&quot;</span> ) )<br>    &#123;<br>        param-&gt;analyse.i_me_method = X264_ME_UMH;<br>        param-&gt;analyse.i_subpel_refine = <span class="hljs-number">10</span>;<br>        param-&gt;analyse.i_me_range = <span class="hljs-number">24</span>;<br>        param-&gt;i_frame_reference = <span class="hljs-number">16</span>;<br>        param-&gt;i_bframe_adaptive = X264_B_ADAPT_TRELLIS;<br>        param-&gt;analyse.i_direct_mv_pred = X264_DIRECT_PRED_AUTO;<br>        param-&gt;analyse.inter |= X264_ANALYSE_PSUB8x8;<br>        param-&gt;analyse.i_trellis = <span class="hljs-number">2</span>;<br>        param-&gt;i_bframe = <span class="hljs-number">8</span>;<br>        param-&gt;rc.i_lookahead = <span class="hljs-number">60</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( !strcasecmp( preset, <span class="hljs-string">&quot;placebo&quot;</span> ) )<br>    &#123;<br>        param-&gt;analyse.i_me_method = X264_ME_TESA;<br>        param-&gt;analyse.i_subpel_refine = <span class="hljs-number">11</span>;<br>        param-&gt;analyse.i_me_range = <span class="hljs-number">24</span>;<br>        param-&gt;i_frame_reference = <span class="hljs-number">16</span>;<br>        param-&gt;i_bframe_adaptive = X264_B_ADAPT_TRELLIS;<br>        param-&gt;analyse.i_direct_mv_pred = X264_DIRECT_PRED_AUTO;<br>        param-&gt;analyse.inter |= X264_ANALYSE_PSUB8x8;<br>        param-&gt;analyse.b_fast_pskip = <span class="hljs-number">0</span>;<br>        param-&gt;analyse.i_trellis = <span class="hljs-number">2</span>;<br>        param-&gt;i_bframe = <span class="hljs-number">16</span>;<br>        param-&gt;rc.i_lookahead = <span class="hljs-number">60</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        x264_log_internal( X264_LOG_ERROR, <span class="hljs-string">&quot;invalid preset &#x27;%s&#x27;\n&quot;</span>, preset );<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//设置tune</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">param_apply_tune</span><span class="hljs-params">( <span class="hljs-type">x264_param_t</span> *param, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *tune )</span><br>&#123;<br>    <span class="hljs-type">int</span> psy_tuning_used = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//这里是循环的，可以设置多个tune</span><br>    <span class="hljs-keyword">for</span>( <span class="hljs-type">int</span> len; tune += <span class="hljs-built_in">strspn</span>( tune, <span class="hljs-string">&quot;,./-+&quot;</span> ), (len = <span class="hljs-built_in">strcspn</span>( tune, <span class="hljs-string">&quot;,./-+&quot;</span> )); tune += len )<br>    &#123;<br>        <span class="hljs-keyword">if</span>( len == <span class="hljs-number">4</span> &amp;&amp; !strncasecmp( tune, <span class="hljs-string">&quot;film&quot;</span>, <span class="hljs-number">4</span> ) )<br>        &#123;<br>            <span class="hljs-keyword">if</span>( psy_tuning_used++ ) <span class="hljs-keyword">goto</span> psy_failure;<br>            param-&gt;i_deblocking_filter_alphac0 = <span class="hljs-number">-1</span>;<br>            param-&gt;i_deblocking_filter_beta = <span class="hljs-number">-1</span>;<br>            param-&gt;analyse.f_psy_trellis = <span class="hljs-number">0.15</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( len == <span class="hljs-number">9</span> &amp;&amp; !strncasecmp( tune, <span class="hljs-string">&quot;animation&quot;</span>, <span class="hljs-number">9</span> ) )<br>        &#123;<br>            <span class="hljs-keyword">if</span>( psy_tuning_used++ ) <span class="hljs-keyword">goto</span> psy_failure;<br>            param-&gt;i_frame_reference = param-&gt;i_frame_reference &gt; <span class="hljs-number">1</span> ? param-&gt;i_frame_reference*<span class="hljs-number">2</span> : <span class="hljs-number">1</span>;<br>            param-&gt;i_deblocking_filter_alphac0 = <span class="hljs-number">1</span>;<br>            param-&gt;i_deblocking_filter_beta = <span class="hljs-number">1</span>;<br>            param-&gt;analyse.f_psy_rd = <span class="hljs-number">0.4</span>;<br>            param-&gt;rc.f_aq_strength = <span class="hljs-number">0.6</span>;<br>            param-&gt;i_bframe += <span class="hljs-number">2</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( len == <span class="hljs-number">5</span> &amp;&amp; !strncasecmp( tune, <span class="hljs-string">&quot;grain&quot;</span>, <span class="hljs-number">5</span> ) )<br>        &#123;<br>            <span class="hljs-keyword">if</span>( psy_tuning_used++ ) <span class="hljs-keyword">goto</span> psy_failure;<br>            param-&gt;i_deblocking_filter_alphac0 = <span class="hljs-number">-2</span>;<br>            param-&gt;i_deblocking_filter_beta = <span class="hljs-number">-2</span>;<br>            param-&gt;analyse.f_psy_trellis = <span class="hljs-number">0.25</span>;<br>            param-&gt;analyse.b_dct_decimate = <span class="hljs-number">0</span>;<br>            param-&gt;rc.f_pb_factor = <span class="hljs-number">1.1</span>;<br>            param-&gt;rc.f_ip_factor = <span class="hljs-number">1.1</span>;<br>            param-&gt;rc.f_aq_strength = <span class="hljs-number">0.5</span>;<br>            param-&gt;analyse.i_luma_deadzone[<span class="hljs-number">0</span>] = <span class="hljs-number">6</span>;<br>            param-&gt;analyse.i_luma_deadzone[<span class="hljs-number">1</span>] = <span class="hljs-number">6</span>;<br>            param-&gt;rc.f_qcompress = <span class="hljs-number">0.8</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( len == <span class="hljs-number">10</span> &amp;&amp; !strncasecmp( tune, <span class="hljs-string">&quot;stillimage&quot;</span>, <span class="hljs-number">10</span> ) )<br>        &#123;<br>            <span class="hljs-keyword">if</span>( psy_tuning_used++ ) <span class="hljs-keyword">goto</span> psy_failure;<br>            param-&gt;i_deblocking_filter_alphac0 = <span class="hljs-number">-3</span>;<br>            param-&gt;i_deblocking_filter_beta = <span class="hljs-number">-3</span>;<br>            param-&gt;analyse.f_psy_rd = <span class="hljs-number">2.0</span>;<br>            param-&gt;analyse.f_psy_trellis = <span class="hljs-number">0.7</span>;<br>            param-&gt;rc.f_aq_strength = <span class="hljs-number">1.2</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( len == <span class="hljs-number">4</span> &amp;&amp; !strncasecmp( tune, <span class="hljs-string">&quot;psnr&quot;</span>, <span class="hljs-number">4</span> ) )<br>        &#123;<br>            <span class="hljs-keyword">if</span>( psy_tuning_used++ ) <span class="hljs-keyword">goto</span> psy_failure;<br>            param-&gt;rc.i_aq_mode = X264_AQ_NONE;<br>            param-&gt;analyse.b_psy = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( len == <span class="hljs-number">4</span> &amp;&amp; !strncasecmp( tune, <span class="hljs-string">&quot;ssim&quot;</span>, <span class="hljs-number">4</span> ) )<br>        &#123;<br>            <span class="hljs-keyword">if</span>( psy_tuning_used++ ) <span class="hljs-keyword">goto</span> psy_failure;<br>            param-&gt;rc.i_aq_mode = X264_AQ_AUTOVARIANCE;<br>            param-&gt;analyse.b_psy = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( len == <span class="hljs-number">10</span> &amp;&amp; !strncasecmp( tune, <span class="hljs-string">&quot;fastdecode&quot;</span>, <span class="hljs-number">10</span> ) )<br>        &#123;<br>            param-&gt;b_deblocking_filter = <span class="hljs-number">0</span>;<br>            param-&gt;b_cabac = <span class="hljs-number">0</span>;<br>            param-&gt;analyse.b_weighted_bipred = <span class="hljs-number">0</span>;<br>            param-&gt;analyse.i_weighted_pred = X264_WEIGHTP_NONE;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( len == <span class="hljs-number">11</span> &amp;&amp; !strncasecmp( tune, <span class="hljs-string">&quot;zerolatency&quot;</span>, <span class="hljs-number">11</span> ) )<br>        &#123;<br>            param-&gt;rc.i_lookahead = <span class="hljs-number">0</span>; <br>            param-&gt;i_sync_lookahead = <span class="hljs-number">0</span>;<br>            param-&gt;i_bframe = <span class="hljs-number">0</span>; <span class="hljs-comment">//关闭b帧</span><br>            param-&gt;b_sliced_threads = <span class="hljs-number">1</span>;<br>            param-&gt;b_vfr_input = <span class="hljs-number">0</span>;<br>            param-&gt;rc.b_mb_tree = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( len == <span class="hljs-number">6</span> &amp;&amp; !strncasecmp( tune, <span class="hljs-string">&quot;touhou&quot;</span>, <span class="hljs-number">6</span> ) )<br>        &#123;<br>            <span class="hljs-keyword">if</span>( psy_tuning_used++ ) <span class="hljs-keyword">goto</span> psy_failure;<br>            param-&gt;i_frame_reference = param-&gt;i_frame_reference &gt; <span class="hljs-number">1</span> ? param-&gt;i_frame_reference*<span class="hljs-number">2</span> : <span class="hljs-number">1</span>;<br>            param-&gt;i_deblocking_filter_alphac0 = <span class="hljs-number">-1</span>;<br>            param-&gt;i_deblocking_filter_beta = <span class="hljs-number">-1</span>;<br>            param-&gt;analyse.f_psy_trellis = <span class="hljs-number">0.2</span>;<br>            param-&gt;rc.f_aq_strength = <span class="hljs-number">1.3</span>;<br>            <span class="hljs-keyword">if</span>( param-&gt;analyse.inter &amp; X264_ANALYSE_PSUB16x16 )<br>                param-&gt;analyse.inter |= X264_ANALYSE_PSUB8x8;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            x264_log_internal( X264_LOG_ERROR, <span class="hljs-string">&quot;invalid tune &#x27;%.*s&#x27;\n&quot;</span>, len, tune );<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    psy_failure:<br>            x264_log_internal( X264_LOG_WARNING, <span class="hljs-string">&quot;only 1 psy tuning can be used: ignoring tune %.*s\n&quot;</span>, len, tune );<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="encode-amp-param-amp-opt"><a href="#encode-amp-param-amp-opt" class="headerlink" title="encode( &amp;param, &amp;opt )"></a>encode( &amp;param, &amp;opt )</h4><p>encode是真正的编码处理，代码开头定义部分如下，开头几个是x264的结构体：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">encode</span><span class="hljs-params">( <span class="hljs-type">x264_param_t</span> *param, <span class="hljs-type">cli_opt_t</span> *opt )</span><br>&#123;<br>    <span class="hljs-type">x264_t</span> *h = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 编码器</span><br>    <span class="hljs-type">x264_picture_t</span> pic; <span class="hljs-comment">// 图像信息</span><br>    <span class="hljs-type">cli_pic_t</span> cli_pic; <span class="hljs-comment">//cli用的图片的信息</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">cli_pulldown_t</span> *pulldown = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// shut up gcc</span><br><br>    <span class="hljs-type">int</span>     i_frame = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span>     i_frame_output = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int64_t</span> i_end, i_previous = <span class="hljs-number">0</span>, i_start = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int64_t</span> i_file = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span>     i_frame_size;<br>    <span class="hljs-type">int64_t</span> last_dts = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int64_t</span> prev_dts = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int64_t</span> first_dts = <span class="hljs-number">0</span>;<br><span class="hljs-meta">#   <span class="hljs-keyword">define</span>  MAX_PTS_WARNING 3 <span class="hljs-comment">/* arbitrary */</span></span><br>    <span class="hljs-type">int</span>     pts_warning_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int64_t</span> largest_pts = <span class="hljs-number">-1</span>;<br>    <span class="hljs-type">int64_t</span> second_largest_pts = <span class="hljs-number">-1</span>;<br>    <span class="hljs-type">int64_t</span> ticks_per_frame;<br>    <span class="hljs-type">double</span>  duration;<br>    <span class="hljs-type">double</span>  pulldown_pts = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span>     retval = <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p>encode 的主要工作是初始化结构体后调用encode_frame函数编码，而encode_frame调用了x264_encoder_encode进行实际的编码。这个函数位于encoder&#x2F;api.c，是个调用函数指针的封装：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">REALIGN_STACK <span class="hljs-type">int</span> <span class="hljs-title function_">x264_encoder_encode</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *h, <span class="hljs-type">x264_nal_t</span> **pp_nal, <span class="hljs-type">int</span> *pi_nal, <span class="hljs-type">x264_picture_t</span> *pic_in, <span class="hljs-type">x264_picture_t</span> *pic_out )</span><br>&#123;<br>    <span class="hljs-type">x264_api_t</span> *api = (<span class="hljs-type">x264_api_t</span> *)h;<br><br>    <span class="hljs-keyword">return</span> api-&gt;encoder_encode( api-&gt;x264, pp_nal, pi_nal, pic_in, pic_out );<br>&#125;<br></code></pre></td></tr></table></figure><p>因此，回到编码器开启的时候寻找当时注册的encode函数，这个注册过程同样实现在encoder&#x2F;api.c：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c">REALIGN_STACK <span class="hljs-type">x264_t</span> *<span class="hljs-title function_">x264_encoder_open</span><span class="hljs-params">( <span class="hljs-type">x264_param_t</span> *param )</span><br>&#123;<br>    <span class="hljs-type">x264_api_t</span> *api = <span class="hljs-built_in">calloc</span>( <span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>( <span class="hljs-type">x264_api_t</span> ) );<br>    <span class="hljs-keyword">if</span>( !api )<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-keyword">if</span>( HAVE_BITDEPTH8 &amp;&amp; param-&gt;i_bitdepth == <span class="hljs-number">8</span> )<br>    &#123;<br>        api-&gt;nal_encode = x264_8_nal_encode;<br>        api-&gt;encoder_reconfig = x264_8_encoder_reconfig;<br>        api-&gt;encoder_parameters = x264_8_encoder_parameters;<br>        api-&gt;encoder_headers = x264_8_encoder_headers;<br>        api-&gt;encoder_encode = x264_8_encoder_encode;<br>        api-&gt;encoder_close = x264_8_encoder_close;<br>        api-&gt;encoder_delayed_frames = x264_8_encoder_delayed_frames;<br>        api-&gt;encoder_maximum_delayed_frames = x264_8_encoder_maximum_delayed_frames;<br>        api-&gt;encoder_intra_refresh = x264_8_encoder_intra_refresh;<br>        api-&gt;encoder_invalidate_reference = x264_8_encoder_invalidate_reference;<br><br>        api-&gt;x264 = x264_8_encoder_open( param );<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( HAVE_BITDEPTH10 &amp;&amp; param-&gt;i_bitdepth == <span class="hljs-number">10</span> )<br>    &#123;<br>        api-&gt;nal_encode = x264_10_nal_encode;<br>        api-&gt;encoder_reconfig = x264_10_encoder_reconfig;<br>        api-&gt;encoder_parameters = x264_10_encoder_parameters;<br>        api-&gt;encoder_headers = x264_10_encoder_headers;<br>        api-&gt;encoder_encode = x264_10_encoder_encode;<br>        api-&gt;encoder_close = x264_10_encoder_close;<br>        api-&gt;encoder_delayed_frames = x264_10_encoder_delayed_frames;<br>        api-&gt;encoder_maximum_delayed_frames = x264_10_encoder_maximum_delayed_frames;<br>        api-&gt;encoder_intra_refresh = x264_10_encoder_intra_refresh;<br>        api-&gt;encoder_invalidate_reference = x264_10_encoder_invalidate_reference;<br><br>        api-&gt;x264 = x264_10_encoder_open( param );<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        x264_log_internal( X264_LOG_ERROR, <span class="hljs-string">&quot;not compiled with %d bit depth support\n&quot;</span>, param-&gt;i_bitdepth );<br><br>    <span class="hljs-keyword">if</span>( !api-&gt;x264 )<br>    &#123;<br>        <span class="hljs-built_in">free</span>( api );<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/* x264_t is opaque */</span><br>    <span class="hljs-keyword">return</span> (<span class="hljs-type">x264_t</span> *)api;<br>&#125;<br></code></pre></td></tr></table></figure><p>目前x264主要是按照8bit和10bit两种不同的深度对调用进行了注册。但是全文搜索并找不到这些指向的函数实现，只能找到定义，同样位于encoder&#x2F;api.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">x264_t</span> *<span class="hljs-title function_">x264_8_encoder_open</span><span class="hljs-params">( <span class="hljs-type">x264_param_t</span> * )</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">x264_8_nal_encode</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *h, <span class="hljs-type">uint8_t</span> *dst, <span class="hljs-type">x264_nal_t</span> *nal )</span>;<br><span class="hljs-type">int</span>  <span class="hljs-title function_">x264_8_encoder_reconfig</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *, <span class="hljs-type">x264_param_t</span> * )</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">x264_8_encoder_parameters</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *, <span class="hljs-type">x264_param_t</span> * )</span>;<br><span class="hljs-type">int</span>  <span class="hljs-title function_">x264_8_encoder_headers</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *, <span class="hljs-type">x264_nal_t</span> **pp_nal, <span class="hljs-type">int</span> *pi_nal )</span>;<br><span class="hljs-type">int</span>  <span class="hljs-title function_">x264_8_encoder_encode</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *, <span class="hljs-type">x264_nal_t</span> **pp_nal, <span class="hljs-type">int</span> *pi_nal, <span class="hljs-type">x264_picture_t</span> *pic_in, <span class="hljs-type">x264_picture_t</span> *pic_out )</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">x264_8_encoder_close</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> * )</span>;<br><span class="hljs-type">int</span>  <span class="hljs-title function_">x264_8_encoder_delayed_frames</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> * )</span>;<br><span class="hljs-type">int</span>  <span class="hljs-title function_">x264_8_encoder_maximum_delayed_frames</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> * )</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">x264_8_encoder_intra_refresh</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> * )</span>;<br><span class="hljs-type">int</span>  <span class="hljs-title function_">x264_8_encoder_invalidate_reference</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *, <span class="hljs-type">int64_t</span> pts )</span>;<br><br><span class="hljs-type">x264_t</span> *<span class="hljs-title function_">x264_10_encoder_open</span><span class="hljs-params">( <span class="hljs-type">x264_param_t</span> * )</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">x264_10_nal_encode</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *h, <span class="hljs-type">uint8_t</span> *dst, <span class="hljs-type">x264_nal_t</span> *nal )</span>;<br><span class="hljs-type">int</span>  <span class="hljs-title function_">x264_10_encoder_reconfig</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *, <span class="hljs-type">x264_param_t</span> * )</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">x264_10_encoder_parameters</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *, <span class="hljs-type">x264_param_t</span> * )</span>;<br><span class="hljs-type">int</span>  <span class="hljs-title function_">x264_10_encoder_headers</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *, <span class="hljs-type">x264_nal_t</span> **pp_nal, <span class="hljs-type">int</span> *pi_nal )</span>;<br><span class="hljs-type">int</span>  <span class="hljs-title function_">x264_10_encoder_encode</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *, <span class="hljs-type">x264_nal_t</span> **pp_nal, <span class="hljs-type">int</span> *pi_nal, <span class="hljs-type">x264_picture_t</span> *pic_in, <span class="hljs-type">x264_picture_t</span> *pic_out )</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">x264_10_encoder_close</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> * )</span>;<br><span class="hljs-type">int</span>  <span class="hljs-title function_">x264_10_encoder_delayed_frames</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> * )</span>;<br><span class="hljs-type">int</span>  <span class="hljs-title function_">x264_10_encoder_maximum_delayed_frames</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> * )</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">x264_10_encoder_intra_refresh</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> * )</span>;<br><span class="hljs-type">int</span>  <span class="hljs-title function_">x264_10_encoder_invalidate_reference</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *, <span class="hljs-type">int64_t</span> pts )</span>;<br></code></pre></td></tr></table></figure><p>在编译后，可以看到x264会生成两种不同位深的.o文件，例如在encoder&#x2F;：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"> &gt; <span class="hljs-built_in">ls</span><br>analyse-10.o  cavlc-8.o        macroblock.c      rdo.c<br>analyse-8.o   cavlc.c          macroblock.h      set-10.o<br>analyse.c     encoder-10.o     me-10.o           set-8.o<br>analyse.h     encoder-8.o      me-8.o            set.c<br>api.c         encoder.c        me.c              set.h<br>api.o         lookahead-10.o   me.h              slicetype.c<br>cabac-10.o    lookahead-8.o    ratecontrol-10.o  slicetype-cl-8.o<br>cabac-8.o     lookahead.c      ratecontrol-8.o   slicetype-cl.c<br>cabac.c       macroblock-10.o  ratecontrol.c     slicetype-cl.h<br>cavlc-10.o    macroblock-8.o   ratecontrol.h<br></code></pre></td></tr></table></figure><p>全局搜索可以看到，相关的实现被x264通过宏定义进行区分(common&#x2F;common.h):</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Macros for templating function calls according to bit depth */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> x264_template(w) x264_glue3(x264, BIT_DEPTH, w)</span><br><br><span class="hljs-comment">/****************************************************************************</span><br><span class="hljs-comment"> * API Templates</span><br><span class="hljs-comment"> ****************************************************************************/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> x264_nal_encode x264_template(nal_encode)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> x264_encoder_reconfig x264_template(encoder_reconfig)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> x264_encoder_parameters x264_template(encoder_parameters)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> x264_encoder_headers x264_template(encoder_headers)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> x264_encoder_encode x264_template(encoder_encode)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> x264_encoder_close x264_template(encoder_close)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> x264_encoder_delayed_frames x264_template(encoder_delayed_frames)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> x264_encoder_maximum_delayed_frames x264_template(encoder_maximum_delayed_frames)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> x264_encoder_intra_refresh x264_template(encoder_intra_refresh)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> x264_encoder_invalidate_reference x264_template(encoder_invalidate_reference) </span><br></code></pre></td></tr></table></figure><p>因此，无论是8bit还是10bit的处理，在API逻辑上没有区别。</p><p>上文API的实现位于encoder&#x2F;encoder.c，现在再回头看之前寻找的编码函数，定义如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/****************************************************************************</span><br><span class="hljs-comment"> * x264_encoder_encode:</span><br><span class="hljs-comment"> *  <span class="hljs-doctag">XXX:</span> i_poc   : is the poc of the current given picture</span><br><span class="hljs-comment"> *       i_frame : is the number of the frame being coded</span><br><span class="hljs-comment"> *  ex:  type frame poc</span><br><span class="hljs-comment"> *       I      0   2*0</span><br><span class="hljs-comment"> *       P      1   2*3</span><br><span class="hljs-comment"> *       B      2   2*1</span><br><span class="hljs-comment"> *       B      3   2*2</span><br><span class="hljs-comment"> *       P      4   2*6</span><br><span class="hljs-comment"> *       B      5   2*4</span><br><span class="hljs-comment"> *       B      6   2*5</span><br><span class="hljs-comment"> ****************************************************************************/</span><br><span class="hljs-type">int</span>     <span class="hljs-title function_">x264_encoder_encode</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *h,</span><br><span class="hljs-params">                             <span class="hljs-type">x264_nal_t</span> **pp_nal, <span class="hljs-type">int</span> *pi_nal,</span><br><span class="hljs-params">                             <span class="hljs-type">x264_picture_t</span> *pic_in,</span><br><span class="hljs-params">                             <span class="hljs-type">x264_picture_t</span> *pic_out )</span> <br></code></pre></td></tr></table></figure><p>该函数的入参如下：</p><pre><code class="hljs"> 1. x264_t *h编码器参数
 2. x264_nal_t **pp_nal 编码的结果
 3. int *pi_nal 已编码的帧数
 4. x264_picture_t *pic_in 存放输入的raw数据
 5. x264_picture_t *pic_out
</code></pre><p>主要调用的函数:</p><ol><li>x264_frame_pop_unused 获取一个没有使用的frame(fenc)</li><li>x264_frame_copy_picture 拷贝raw数据到fenc</li><li>x264_frame_expand_border_mod16 对分辨率不是16倍数的帧，增加pad位进行扩边</li><li>x264_macroblock_tree_read mb-tree相关的码率控制</li><li>x264_adaptive_quant_frame 宏块级码率控制</li><li>x264_frame_init_lowres 1&#x2F;2像素的内插</li><li>x264_lookahead_put_frame 将帧加入lookahead分析</li><li>x264_lookahead_get_frames 从lookahead取出帧</li><li>x264_frame_shift 从队列中取出用于编码的帧</li><li>x264_ratecontrol_zone_init 码率控制初始化</li><li>reference_reset 清空参考帧列表</li><li>reference_hierarchy_reset 在帧类型为I帧，P帧等类型时，调用判断是否重置参考帧</li><li>reference_build_list 建立参考帧列表，list0，list1</li><li>x264_ratecontrol_start 开启码率控制，选择合适的QP</li><li>x264_ratecontrol_qp 获取计算出的QP</li><li>slice_init 创建头信息</li><li>slices_write 真正的编码函数，内部进行了编码</li><li>encoder_frame_end 编码后的处理内容</li></ol><h4 id="码率控制"><a href="#码率控制" class="headerlink" title="码率控制"></a>码率控制</h4><p>x264_ratecontrol相关的处理被定义在encoder&#x2F;ratecontrol.c当中。其中，x264_ratecontrol_start的ratecontrol针对的是帧层级的计算。在该函数中，主要进行帧预期QP值的运算，主要使用ABR，2-PASS和VBV三种控制方式。</p><h5 id="ABR算法-amp-amp-2-PASS-ABR"><a href="#ABR算法-amp-amp-2-PASS-ABR" class="headerlink" title="ABR算法 &amp;&amp; 2-PASS ABR"></a>ABR算法 &amp;&amp; 2-PASS ABR</h5><p>在x264_ratecontrol_start函数中, 关于ABR和2-PASS ABR计算，主要是如下几行：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>( rc-&gt;b_abr )<br>&#123;<br>    q = qscale2qp( rate_estimate_qscale( h ) );<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( rc-&gt;b_2pass )<br>&#123;<br>    rce-&gt;new_qscale = rate_estimate_qscale( h );<br>    q = qscale2qp( rce-&gt;new_qscale );<br>&#125;<br></code></pre></td></tr></table></figure><p>其中q代表ABR算法计算的QP值；下面分析函数的调用（这里看的是原生代码，不是优化后代码）</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> QP_BD_OFFSET (6*(BIT_DEPTH-8))</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">float</span> <span class="hljs-title function_">qscale2qp</span><span class="hljs-params">( <span class="hljs-type">float</span> qscale )</span><br>&#123;<br>    <span class="hljs-keyword">return</span> (<span class="hljs-number">12.0f</span> + QP_BD_OFFSET) + <span class="hljs-number">6.0f</span> * log2f( qscale/<span class="hljs-number">0.85f</span> );<br>&#125;<br></code></pre></td></tr></table></figure><p>这个函数代表了计算ABR的换算公式，x264选择了固定的公式（经验公式）换算qscale和qp。此时查看反向的切换</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">float</span> <span class="hljs-title function_">qp2qscale</span><span class="hljs-params">( <span class="hljs-type">float</span> qp )</span><br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0.85f</span> * powf( <span class="hljs-number">2.0f</span>, ( qp - (<span class="hljs-number">12.0f</span> + QP_BD_OFFSET) ) / <span class="hljs-number">6.0f</span> );<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到公式为 （假设是8bit位深）<br>$$<br>qscale &#x3D; 0.85*2.0^{(qp - 12.0)&#x2F;6.0}<br>$$<br>qscale和每帧的bits也存在线性关系，因此先计算qscale，再转换成qp即可进行码率初步控制；</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// update qscale for 1 frame based on actual bits used so far</span><br><span class="hljs-type">static</span> <span class="hljs-type">float</span> <span class="hljs-title function_">rate_estimate_qscale</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *h )</span><br>&#123;<br>    <span class="hljs-type">float</span> q;<br>    <span class="hljs-type">x264_ratecontrol_t</span> *rcc = h-&gt;rc;<br>    <span class="hljs-type">ratecontrol_entry_t</span> rce = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">int</span> pict_type = h-&gt;sh.i_type;<br>    <span class="hljs-comment">// 这里进行总的比特的计算</span><br>    <span class="hljs-type">int64_t</span> total_bits = <span class="hljs-number">8</span>*(h-&gt;stat.i_frame_size[SLICE_TYPE_I] <br>                          + h-&gt;stat.i_frame_size[SLICE_TYPE_P]<br>                          + h-&gt;stat.i_frame_size[SLICE_TYPE_B])<br>                       - rcc-&gt;filler_bits_sum; <span class="hljs-comment">//这里减掉了帧填充数据</span><br><br>    <span class="hljs-comment">//如果2pass获取句柄</span><br>    <span class="hljs-keyword">if</span>( rcc-&gt;b_2pass )<br>    &#123;<br>        rce = *rcc-&gt;rce;<br>        <span class="hljs-keyword">if</span>( pict_type != rce.pict_type )<br>        &#123;<br>            x264_log( h, X264_LOG_ERROR, <span class="hljs-string">&quot;slice=%c but 2pass stats say %c\n&quot;</span>,<br>                      slice_type_to_char[pict_type], slice_type_to_char[rce.pict_type] );<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>( pict_type == SLICE_TYPE_B )<br>    &#123;<br>        <span class="hljs-comment">/* B-frames don&#x27;t have independent ratecontrol, but rather get the</span><br><span class="hljs-comment">         * average QP of the two adjacent P-frames + an offset */</span><br><br>        <span class="hljs-type">int</span> i0 = IS_X264_TYPE_I(h-&gt;fref_nearest[<span class="hljs-number">0</span>]-&gt;i_type);<br>        <span class="hljs-type">int</span> i1 = IS_X264_TYPE_I(h-&gt;fref_nearest[<span class="hljs-number">1</span>]-&gt;i_type);<br>        <span class="hljs-type">int</span> dt0 = <span class="hljs-built_in">abs</span>(h-&gt;fenc-&gt;i_poc - h-&gt;fref_nearest[<span class="hljs-number">0</span>]-&gt;i_poc);<br>        <span class="hljs-type">int</span> dt1 = <span class="hljs-built_in">abs</span>(h-&gt;fenc-&gt;i_poc - h-&gt;fref_nearest[<span class="hljs-number">1</span>]-&gt;i_poc);<br>        <span class="hljs-type">float</span> q0 = h-&gt;fref_nearest[<span class="hljs-number">0</span>]-&gt;f_qp_avg_rc;<br>        <span class="hljs-type">float</span> q1 = h-&gt;fref_nearest[<span class="hljs-number">1</span>]-&gt;f_qp_avg_rc;<br><br>        <span class="hljs-keyword">if</span>( h-&gt;fref_nearest[<span class="hljs-number">0</span>]-&gt;i_type == X264_TYPE_BREF )<br>            q0 -= rcc-&gt;pb_offset/<span class="hljs-number">2</span>;<br>        <span class="hljs-keyword">if</span>( h-&gt;fref_nearest[<span class="hljs-number">1</span>]-&gt;i_type == X264_TYPE_BREF )<br>            q1 -= rcc-&gt;pb_offset/<span class="hljs-number">2</span>;<br><br>        <span class="hljs-keyword">if</span>( i0 &amp;&amp; i1 )<br>            q = (q0 + q1) / <span class="hljs-number">2</span> + rcc-&gt;ip_offset;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( i0 )<br>            q = q1;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( i1 )<br>            q = q0;<br>        <span class="hljs-keyword">else</span><br>            q = (q0*dt1 + q1*dt0) / (dt0 + dt1);<br><br>        <span class="hljs-keyword">if</span>( h-&gt;fenc-&gt;b_kept_as_ref )<br>            q += rcc-&gt;pb_offset/<span class="hljs-number">2</span>;<br>        <span class="hljs-keyword">else</span><br>            q += rcc-&gt;pb_offset;<br><br>        rcc-&gt;qp_novbv = q;<br>        q = qp2qscale( q );<br>        <span class="hljs-comment">//估算当前帧的体积</span><br>        <span class="hljs-keyword">if</span>( rcc-&gt;b_2pass )<br>            rcc-&gt;frame_size_planned = qscale2bits( &amp;rce, q );<br>        <span class="hljs-keyword">else</span><br>            rcc-&gt;frame_size_planned = predict_size( rcc-&gt;pred_b_from_p, q, h-&gt;fref[<span class="hljs-number">1</span>][h-&gt;i_ref[<span class="hljs-number">1</span>]<span class="hljs-number">-1</span>]-&gt;i_satd );<br>        <span class="hljs-comment">/* Limit planned size by MinCR */</span><br>        <span class="hljs-keyword">if</span>( rcc-&gt;b_vbv )<br>            rcc-&gt;frame_size_planned = X264_MIN( rcc-&gt;frame_size_planned, rcc-&gt;frame_size_maximum );<br>        rcc-&gt;frame_size_estimated = rcc-&gt;frame_size_planned;<br><br>        <span class="hljs-comment">/* For row SATDs */</span><br>        <span class="hljs-keyword">if</span>( rcc-&gt;b_vbv )<br>            rcc-&gt;last_satd = x264_rc_analyse_slice( h );<br>        <span class="hljs-keyword">return</span> q;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-type">double</span> abr_buffer = <span class="hljs-number">2</span> * rcc-&gt;rate_tolerance * rcc-&gt;bitrate;<br>        <span class="hljs-type">double</span> predicted_bits = total_bits;<br>        <span class="hljs-comment">//多线程更新predict_bits</span><br>        <span class="hljs-keyword">if</span>( h-&gt;i_thread_frames &gt; <span class="hljs-number">1</span> )<br>        &#123;<br>            <span class="hljs-type">int</span> j = rcc - h-&gt;thread[<span class="hljs-number">0</span>]-&gt;rc;<br>            <span class="hljs-keyword">for</span>( <span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; h-&gt;i_thread_frames; i++ )<br>            &#123;<br>                <span class="hljs-type">x264_t</span> *t = h-&gt;thread[(j+i) % h-&gt;i_thread_frames];<br>                <span class="hljs-type">double</span> bits = t-&gt;rc-&gt;frame_size_planned;<br>                <span class="hljs-keyword">if</span>( !t-&gt;b_thread_active )<br>                    <span class="hljs-keyword">continue</span>;<br>                bits = X264_MAX(bits, t-&gt;rc-&gt;frame_size_estimated);<br>                predicted_bits += bits;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>( rcc-&gt;b_2pass )<br>        &#123;<br>            <span class="hljs-type">double</span> lmin = rcc-&gt;lmin[pict_type];<br>            <span class="hljs-type">double</span> lmax = rcc-&gt;lmax[pict_type];<br>            <span class="hljs-type">double</span> diff;<br><br>            <span class="hljs-comment">/* Adjust ABR buffer based on distance to the end of the video. */</span><br>            <span class="hljs-keyword">if</span>( rcc-&gt;num_entries &gt; h-&gt;i_frame )<br>            &#123;<br>                <span class="hljs-type">double</span> final_bits = rcc-&gt;entry_out[rcc-&gt;num_entries<span class="hljs-number">-1</span>]-&gt;expected_bits;<br>                <span class="hljs-type">double</span> video_pos = rce.expected_bits / final_bits;<br>                <span class="hljs-type">double</span> scale_factor = <span class="hljs-built_in">sqrt</span>( (<span class="hljs-number">1</span> - video_pos) * rcc-&gt;num_entries );<br>                abr_buffer *= <span class="hljs-number">0.5</span> * X264_MAX( scale_factor, <span class="hljs-number">0.5</span> );<br>            &#125;<br><br>            diff = predicted_bits - rce.expected_bits;<br>            q = rce.new_qscale;<br>            q /= x264_clip3f((abr_buffer - diff) / abr_buffer, <span class="hljs-number">.5</span>, <span class="hljs-number">2</span>);<br>            <span class="hljs-keyword">if</span>( h-&gt;i_frame &gt;= rcc-&gt;fps &amp;&amp; rcc-&gt;expected_bits_sum &gt;= <span class="hljs-number">1</span> )<br>            &#123;<br>                <span class="hljs-comment">/* Adjust quant based on the difference between</span><br><span class="hljs-comment">                 * achieved and expected bitrate so far */</span><br>                <span class="hljs-type">double</span> cur_time = (<span class="hljs-type">double</span>)h-&gt;i_frame / rcc-&gt;num_entries;<br>                <span class="hljs-type">double</span> w = x264_clip3f( cur_time*<span class="hljs-number">100</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span> );<br>                q *= <span class="hljs-built_in">pow</span>( (<span class="hljs-type">double</span>)total_bits / rcc-&gt;expected_bits_sum, w );<br>            &#125;<br>            rcc-&gt;qp_novbv = qscale2qp( q );<br>            <span class="hljs-keyword">if</span>( rcc-&gt;b_vbv )<br>            &#123;<br>                <span class="hljs-comment">/* Do not overflow vbv */</span><br>                <span class="hljs-type">double</span> expected_size = qscale2bits( &amp;rce, q );<br>                <span class="hljs-type">double</span> expected_vbv = rcc-&gt;buffer_fill + rcc-&gt;buffer_rate - expected_size;<br>                <span class="hljs-type">double</span> expected_fullness = rce.expected_vbv / rcc-&gt;buffer_size;<br>                <span class="hljs-type">double</span> qmax = q*(<span class="hljs-number">2</span> - expected_fullness);<br>                <span class="hljs-type">double</span> size_constraint = <span class="hljs-number">1</span> + expected_fullness;<br>                qmax = X264_MAX( qmax, rce.new_qscale );<br>                <span class="hljs-keyword">if</span>( expected_fullness &lt; <span class="hljs-number">.05</span> )<br>                    qmax = lmax;<br>                qmax = X264_MIN(qmax, lmax);<br>                <span class="hljs-keyword">while</span>( ((expected_vbv &lt; rce.expected_vbv/size_constraint) &amp;&amp; (q &lt; qmax)) ||<br>                        ((expected_vbv &lt; <span class="hljs-number">0</span>) &amp;&amp; (q &lt; lmax)))<br>                &#123;<br>                    q *= <span class="hljs-number">1.05</span>;<br>                    expected_size = qscale2bits(&amp;rce, q);<br>                    expected_vbv = rcc-&gt;buffer_fill + rcc-&gt;buffer_rate - expected_size;<br>                &#125;<br>                rcc-&gt;last_satd = x264_rc_analyse_slice( h );<br>            &#125;<br>            q = x264_clip3f( q, lmin, lmax );<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-comment">/* 1pass ABR */</span><br>        &#123;<br>            <span class="hljs-comment">/* Calculate the quantizer which would have produced the desired</span><br><span class="hljs-comment">             * average bitrate if it had been applied to all frames so far.</span><br><span class="hljs-comment">             * Then modulate that quant based on the current frame&#x27;s complexity</span><br><span class="hljs-comment">             * relative to the average complexity so far (using the 2pass RCEQ).</span><br><span class="hljs-comment">             * Then bias the quant up or down if total size so far was far from</span><br><span class="hljs-comment">             * the target.</span><br><span class="hljs-comment">             * Result: Depending on the value of rate_tolerance, there is a</span><br><span class="hljs-comment">             * tradeoff between quality and bitrate precision. But at large</span><br><span class="hljs-comment">             * tolerances, the bit distribution approaches that of 2pass. */</span><br><br>            <span class="hljs-type">double</span> wanted_bits, overflow = <span class="hljs-number">1</span>;<br><br>            <span class="hljs-comment">//获取最新的satd</span><br>            rcc-&gt;last_satd = x264_rc_analyse_slice( h );<br>            <span class="hljs-comment">//更新cplxsum和cplxcount</span><br>            rcc-&gt;short_term_cplxsum *= <span class="hljs-number">0.5</span>;<br>            rcc-&gt;short_term_cplxcount *= <span class="hljs-number">0.5</span>;<br>            rcc-&gt;short_term_cplxsum += rcc-&gt;last_satd / (CLIP_DURATION(h-&gt;fenc-&gt;f_duration) / BASE_FRAME_DURATION);<br>            rcc-&gt;short_term_cplxcount ++;<br><br>            <span class="hljs-comment">//rce的初始化</span><br>            rce.tex_bits = rcc-&gt;last_satd;<br>            rce.blurred_complexity = rcc-&gt;short_term_cplxsum / rcc-&gt;short_term_cplxcount;<br>            rce.mv_bits = <span class="hljs-number">0</span>;<br>            rce.p_count = rcc-&gt;nmb;<br>            rce.i_count = <span class="hljs-number">0</span>;<br>            rce.s_count = <span class="hljs-number">0</span>;<br>            rce.qscale = <span class="hljs-number">1</span>;<br>            rce.pict_type = pict_type;<br>            rce.i_duration = h-&gt;fenc-&gt;i_duration;<br><br>            <span class="hljs-keyword">if</span>( h-&gt;param.rc.i_rc_method == X264_RC_CRF ) <span class="hljs-comment">//crf</span><br>            &#123;<br>                q = get_qscale( h, &amp;rce, rcc-&gt;rate_factor_constant, h-&gt;fenc-&gt;i_frame );<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                q = get_qscale( h, &amp;rce, rcc-&gt;wanted_bits_window / rcc-&gt;cplxr_sum, h-&gt;fenc-&gt;i_frame );<br><br>                <span class="hljs-comment">/* ABR code can potentially be counterproductive in CBR, so just don&#x27;t bother.</span><br><span class="hljs-comment">                 * Don&#x27;t run it if the frame complexity is zero either. */</span><br>                <span class="hljs-keyword">if</span>( !rcc-&gt;b_vbv_min_rate &amp;&amp; rcc-&gt;last_satd ) <span class="hljs-comment">//没开启vbv就进行二次调整</span><br>                &#123;<br>                    <span class="hljs-comment">// FIXME is it simpler to keep track of wanted_bits in ratecontrol_end?</span><br>                    <span class="hljs-type">int</span> i_frame_done = h-&gt;i_frame;<br>                    <span class="hljs-comment">//播放需要的时间</span><br>                    <span class="hljs-type">double</span> time_done = i_frame_done / rcc-&gt;fps;<br>                    <span class="hljs-keyword">if</span>( h-&gt;param.b_vfr_input &amp;&amp; i_frame_done &gt; <span class="hljs-number">0</span> )<br>                        time_done = ((<span class="hljs-type">double</span>)(h-&gt;fenc-&gt;i_reordered_pts - h-&gt;i_reordered_pts_delay)) * h-&gt;param.i_timebase_num / h-&gt;param.i_timebase_den;<br>                    wanted_bits = time_done * rcc-&gt;bitrate;<br>                    <span class="hljs-keyword">if</span>( wanted_bits &gt; <span class="hljs-number">0</span> )<br>                    &#123;<br>                        abr_buffer *= X264_MAX( <span class="hljs-number">1</span>, <span class="hljs-built_in">sqrt</span>( time_done ) );<br>                        overflow = x264_clip3f( <span class="hljs-number">1.0</span> + (predicted_bits - wanted_bits) / abr_buffer, <span class="hljs-number">.5</span>, <span class="hljs-number">2</span> );<br>                        q *= overflow;<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span>( pict_type == SLICE_TYPE_I &amp;&amp; h-&gt;param.i_keyint_max &gt; <span class="hljs-number">1</span><br>                <span class="hljs-comment">/* should test _next_ pict type, but that isn&#x27;t decided yet */</span><br>                &amp;&amp; rcc-&gt;last_non_b_pict_type != SLICE_TYPE_I )<br>            &#123;<br>                q = qp2qscale( rcc-&gt;accum_p_qp / rcc-&gt;accum_p_norm );<br>                q /= h-&gt;param.rc.f_ip_factor;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( h-&gt;i_frame &gt; <span class="hljs-number">0</span> )<br>            &#123;<br>                <span class="hljs-keyword">if</span>( h-&gt;param.rc.i_rc_method != X264_RC_CRF )<br>                &#123;<br>                    <span class="hljs-comment">/* Asymmetric clipping, because symmetric would prevent</span><br><span class="hljs-comment">                     * overflow control in areas of rapidly oscillating complexity */</span><br>                    <span class="hljs-type">double</span> lmin = rcc-&gt;last_qscale_for[pict_type] / rcc-&gt;lstep;<br>                    <span class="hljs-type">double</span> lmax = rcc-&gt;last_qscale_for[pict_type] * rcc-&gt;lstep;<br>                    <span class="hljs-keyword">if</span>( overflow &gt; <span class="hljs-number">1.1</span> &amp;&amp; h-&gt;i_frame &gt; <span class="hljs-number">3</span> )<br>                        lmax *= rcc-&gt;lstep;<br>                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( overflow &lt; <span class="hljs-number">0.9</span> )<br>                        lmin /= rcc-&gt;lstep;<br><br>                    q = x264_clip3f(q, lmin, lmax);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>( h-&gt;param.rc.i_rc_method == X264_RC_CRF &amp;&amp; rcc-&gt;qcompress != <span class="hljs-number">1</span> )<br>            &#123;<br>                q = qp2qscale( ABR_INIT_QP ) / h-&gt;param.rc.f_ip_factor;<br>            &#125;<br>            rcc-&gt;qp_novbv = qscale2qp( q );<br><br>            <span class="hljs-comment">//FIXME use get_diff_limited_q() ?</span><br>            q = clip_qscale( h, pict_type, q );<br>        &#125;<br><br>        rcc-&gt;last_qscale_for[pict_type] =<br>        rcc-&gt;last_qscale = q;<br><br>        <span class="hljs-keyword">if</span>( !(rcc-&gt;b_2pass &amp;&amp; !rcc-&gt;b_vbv) &amp;&amp; h-&gt;fenc-&gt;i_frame == <span class="hljs-number">0</span> )<br>            rcc-&gt;last_qscale_for[SLICE_TYPE_P] = q * h-&gt;param.rc.f_ip_factor;<br><br>        <span class="hljs-keyword">if</span>( rcc-&gt;b_2pass )<br>            rcc-&gt;frame_size_planned = qscale2bits( &amp;rce, q );<br>        <span class="hljs-keyword">else</span><br>            rcc-&gt;frame_size_planned = predict_size( &amp;rcc-&gt;pred[h-&gt;sh.i_type], q, rcc-&gt;last_satd );<br><br>        <span class="hljs-comment">/* Always use up the whole VBV in this case. */</span><br>        <span class="hljs-keyword">if</span>( rcc-&gt;single_frame_vbv )<br>            rcc-&gt;frame_size_planned = rcc-&gt;buffer_rate;<br>        <span class="hljs-comment">/* Limit planned size by MinCR */</span><br>        <span class="hljs-keyword">if</span>( rcc-&gt;b_vbv )<br>            rcc-&gt;frame_size_planned = X264_MIN( rcc-&gt;frame_size_planned, rcc-&gt;frame_size_maximum );<br>        rcc-&gt;frame_size_estimated = rcc-&gt;frame_size_planned;<br>        <span class="hljs-keyword">return</span> q;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>根据这段代码，可以绘制如下流程图：</p><div align="center"><text>rate_estimate_qscale流程图</text><img src="https://nyamori.oss-cn-shanghai.aliyuncs.com/img/rate_estimate_qscale流程图.jpg" srcset="/img/loading.gif" lazyload width="100%" height="100%" style="border:0;box-shadow:none"></div><h5 id="VBV算法"><a href="#VBV算法" class="headerlink" title="VBV算法"></a>VBV算法</h5><p>x264_ratecontrol_start中关于vbv的代码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>( rc-&gt;b_vbv )<br>&#123;<br>    <span class="hljs-built_in">memset</span>( h-&gt;fdec-&gt;i_row_bits, <span class="hljs-number">0</span>, h-&gt;mb.i_mb_height * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>) );<br>    <span class="hljs-built_in">memset</span>( h-&gt;fdec-&gt;f_row_qp, <span class="hljs-number">0</span>, h-&gt;mb.i_mb_height * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>) );<br>    <span class="hljs-built_in">memset</span>( h-&gt;fdec-&gt;f_row_qscale, <span class="hljs-number">0</span>, h-&gt;mb.i_mb_height * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">float</span>) );<br>    rc-&gt;row_pred = rc-&gt;row_preds[h-&gt;sh.i_type];<br>    rc-&gt;buffer_rate = h-&gt;fenc-&gt;i_cpb_duration * rc-&gt;vbv_max_rate * h-&gt;sps-&gt;vui.i_num_units_in_tick / h-&gt;sps-&gt;vui.i_time_scale;<br>    update_vbv_plan( h, overhead ); <span class="hljs-comment">//根据当前的帧大小更新vbv</span><br><br>    <span class="hljs-type">const</span> <span class="hljs-type">x264_level_t</span> *l = x264_levels;<br>    <span class="hljs-keyword">while</span>( l-&gt;level_idc != <span class="hljs-number">0</span> &amp;&amp; l-&gt;level_idc != h-&gt;param.i_level_idc )<br>        l++;<br><br>    <span class="hljs-comment">//获取最小的压缩比</span><br>    <span class="hljs-type">int</span> mincr = l-&gt;mincr;<br><br>    <span class="hljs-keyword">if</span>( h-&gt;param.b_bluray_compat )<br>        mincr = <span class="hljs-number">4</span>;<br><br>    <span class="hljs-comment">/* Profiles above High don&#x27;t require minCR, so just set the maximum to a large value. */</span><br>    <span class="hljs-keyword">if</span>( h-&gt;sps-&gt;i_profile_idc &gt; PROFILE_HIGH )<br>        rc-&gt;frame_size_maximum = <span class="hljs-number">1e9</span>;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-comment">/* The spec has a bizarre special case for the first frame. 第一帧的特殊处理*/</span><br>        <span class="hljs-keyword">if</span>( h-&gt;i_frame == <span class="hljs-number">0</span> )<br>        &#123;<br>            <span class="hljs-comment">//384 * ( Max( PicSizeInMbs, fR * MaxMBPS ) + MaxMBPS * ( tr( 0 ) - tr,n( 0 ) ) ) / MinCR</span><br>            <span class="hljs-type">double</span> fr = <span class="hljs-number">1.</span> / (h-&gt;param.i_level_idc &gt;= <span class="hljs-number">60</span> ? <span class="hljs-number">300</span> : <span class="hljs-number">172</span>);<br>            <span class="hljs-type">int</span> pic_size_in_mbs = h-&gt;mb.i_mb_width * h-&gt;mb.i_mb_height;<br>            rc-&gt;frame_size_maximum = <span class="hljs-number">384</span> * BIT_DEPTH * X264_MAX( pic_size_in_mbs, fr*l-&gt;mbps ) / mincr;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-comment">//384 * MaxMBPS * ( tr( n ) - tr( n - 1 ) ) / MinCR</span><br>            rc-&gt;frame_size_maximum = <span class="hljs-number">384</span> * BIT_DEPTH * ((<span class="hljs-type">double</span>)h-&gt;fenc-&gt;i_cpb_duration * h-&gt;sps-&gt;vui.i_num_units_in_tick / h-&gt;sps-&gt;vui.i_time_scale) * l-&gt;mbps / mincr;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>update_vbv_plan函数如下，可以发现这个函数主要更新了buffer_fill作为计划缓冲区。实际的更新不在这里。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// provisionally update VBV according to the planned size of all frames currently in progress</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">update_vbv_plan</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *h, <span class="hljs-type">int</span> overhead )</span><br>&#123;<br>    <span class="hljs-type">x264_ratecontrol_t</span> *rcc = h-&gt;rc;<br>    rcc-&gt;buffer_fill = h-&gt;thread[<span class="hljs-number">0</span>]-&gt;rc-&gt;buffer_fill_final_min / h-&gt;sps-&gt;vui.i_time_scale;<br>    <span class="hljs-comment">//多线程情况</span><br>    <span class="hljs-keyword">if</span>( h-&gt;i_thread_frames &gt; <span class="hljs-number">1</span> )<br>    &#123;<br>        <span class="hljs-type">int</span> j = rcc - h-&gt;thread[<span class="hljs-number">0</span>]-&gt;rc;<br>        <span class="hljs-keyword">for</span>( <span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; h-&gt;i_thread_frames; i++ )<br>        &#123;<br>            <span class="hljs-type">x264_t</span> *t = h-&gt;thread[ (j+i)%h-&gt;i_thread_frames ];<br>            <span class="hljs-type">double</span> bits = t-&gt;rc-&gt;frame_size_planned;<br>            <span class="hljs-keyword">if</span>( !t-&gt;b_thread_active )<br>                <span class="hljs-keyword">continue</span>;<br>            bits = X264_MAX(bits, t-&gt;rc-&gt;frame_size_estimated);<br>            rcc-&gt;buffer_fill -= bits;<br>            rcc-&gt;buffer_fill = X264_MAX( rcc-&gt;buffer_fill, <span class="hljs-number">0</span> );<br>            rcc-&gt;buffer_fill += t-&gt;rc-&gt;buffer_rate;<br>            rcc-&gt;buffer_fill = X264_MIN( rcc-&gt;buffer_fill, rcc-&gt;buffer_size );<br>        &#125;<br>    &#125;<br>    rcc-&gt;buffer_fill = X264_MIN( rcc-&gt;buffer_fill, rcc-&gt;buffer_size );<br>    rcc-&gt;buffer_fill -= overhead;<br>&#125;<br></code></pre></td></tr></table></figure><p>实际的更新在完成编码之后，由x264_ratecontrol_end调用update_vbv;这个函数更新了buffer_fill_final，代表vbv最后实际使用的bits。vbv算法还有许多宏块级的处理，分散在代码中，本次学习暂时没有分析相关内容</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// update VBV after encoding a frame</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update_vbv</span><span class="hljs-params">( <span class="hljs-type">x264_t</span> *h, <span class="hljs-type">int</span> bits )</span><br>&#123;<br>    <span class="hljs-type">int</span> filler = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> bitrate = h-&gt;sps-&gt;vui.hrd.i_bit_rate_unscaled;<br>    <span class="hljs-type">x264_ratecontrol_t</span> *rcc = h-&gt;rc;<br>    <span class="hljs-type">x264_ratecontrol_t</span> *rct = h-&gt;thread[<span class="hljs-number">0</span>]-&gt;rc;<br>    <span class="hljs-type">int64_t</span> buffer_size = (<span class="hljs-type">int64_t</span>)h-&gt;sps-&gt;vui.hrd.i_cpb_size_unscaled * h-&gt;sps-&gt;vui.i_time_scale;<br><br>    <span class="hljs-keyword">if</span>( rcc-&gt;last_satd &gt;= h-&gt;mb.i_mb_count )<br>        update_predictor( &amp;rct-&gt;pred[h-&gt;sh.i_type], qp2qscale( rcc-&gt;qpa_rc ), rcc-&gt;last_satd, bits );<br><br>    <span class="hljs-keyword">if</span>( !rcc-&gt;b_vbv )<br>        <span class="hljs-keyword">return</span> filler;<br><br>    <span class="hljs-type">uint64_t</span> buffer_diff = (<span class="hljs-type">uint64_t</span>)bits * h-&gt;sps-&gt;vui.i_time_scale;<br>    rct-&gt;buffer_fill_final -= buffer_diff;<br>    rct-&gt;buffer_fill_final_min -= buffer_diff;<br><br>    <span class="hljs-keyword">if</span>( rct-&gt;buffer_fill_final_min &lt; <span class="hljs-number">0</span> )<br>    &#123;<br>        <span class="hljs-type">double</span> underflow = (<span class="hljs-type">double</span>)rct-&gt;buffer_fill_final_min / h-&gt;sps-&gt;vui.i_time_scale;<br>        <span class="hljs-keyword">if</span>( rcc-&gt;rate_factor_max_increment &amp;&amp; rcc-&gt;qpm &gt;= rcc-&gt;qp_novbv + rcc-&gt;rate_factor_max_increment )<br>            x264_log( h, X264_LOG_DEBUG, <span class="hljs-string">&quot;VBV underflow due to CRF-max (frame %d, %.0f bits)\n&quot;</span>, h-&gt;i_frame, underflow );<br>        <span class="hljs-keyword">else</span><br>            x264_log( h, X264_LOG_WARNING, <span class="hljs-string">&quot;VBV underflow (frame %d, %.0f bits)\n&quot;</span>, h-&gt;i_frame, underflow );<br>        rct-&gt;buffer_fill_final =<br>        rct-&gt;buffer_fill_final_min = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>( h-&gt;param.i_avcintra_class )<br>        buffer_diff = buffer_size;<br>    <span class="hljs-keyword">else</span><br>        buffer_diff = (<span class="hljs-type">uint64_t</span>)bitrate * h-&gt;sps-&gt;vui.i_num_units_in_tick * h-&gt;fenc-&gt;i_cpb_duration;<br>    rct-&gt;buffer_fill_final += buffer_diff;<br>    rct-&gt;buffer_fill_final_min += buffer_diff;<br><br>    <span class="hljs-keyword">if</span>( rct-&gt;buffer_fill_final &gt; buffer_size )<br>    &#123;<br>        <span class="hljs-keyword">if</span>( h-&gt;param.rc.b_filler )<br>        &#123;<br>            <span class="hljs-type">int64_t</span> scale = (<span class="hljs-type">int64_t</span>)h-&gt;sps-&gt;vui.i_time_scale * <span class="hljs-number">8</span>;<br>            filler = (rct-&gt;buffer_fill_final - buffer_size + scale - <span class="hljs-number">1</span>) / scale;<br>            bits = h-&gt;param.i_avcintra_class ? filler * <span class="hljs-number">8</span> : X264_MAX( (FILLER_OVERHEAD - h-&gt;param.b_annexb), filler ) * <span class="hljs-number">8</span>;<br>            buffer_diff = (<span class="hljs-type">uint64_t</span>)bits * h-&gt;sps-&gt;vui.i_time_scale;<br>            rct-&gt;buffer_fill_final -= buffer_diff;<br>            rct-&gt;buffer_fill_final_min -= buffer_diff;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            rct-&gt;buffer_fill_final = X264_MIN( rct-&gt;buffer_fill_final, buffer_size );<br>            rct-&gt;buffer_fill_final_min = X264_MIN( rct-&gt;buffer_fill_final_min, buffer_size );<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> filler;<br>&#125;<br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E7%AC%94%E8%AE%B0/" class="category-chain-item">笔记</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/H-264/">#H.264</a> <a href="/tags/x264/">#x264</a></div></div><div class="license-box my-3"><div class="license-title"><div>x264学习笔记</div><div>http://nyamori.icu/2022/04/28/x264学习笔记/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Nyamori</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2022年4月28日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2022/05/27/32%E4%BD%8D%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E8%BD%AC64%E4%BD%8D%E7%AC%94%E8%AE%B0/" title="32位应用程序转64位笔记"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">32位应用程序转64位笔记</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2022/04/18/Simulcast%E7%9A%84%E6%96%B0%E6%A0%87%E5%87%86-rfc8853%E7%AC%94%E8%AE%B0/" title="Simulcast的新标准-rfc8853笔记"><span class="hidden-mobile">Simulcast的新标准-rfc8853笔记</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="gitalk-container"></div><script type="text/javascript">Fluid.utils.loadComments("#gitalk-container",(function(){Fluid.utils.createCssLink("/css/gitalk.css"),Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js",(function(){var e=Object.assign({clientID:"c333f0bfec8178c544f0",clientSecret:"78bed7304f63037f15787d415735465fb3744f7b",repo:"nyamori.github.io",owner:"nyamori",admin:["nyamori"],language:"zh-CN",labels:["Gitalk"],perPage:10,pagerDirection:"last",distractionFreeMode:!1,createIssueManually:!0,proxy:"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},{id:"cd0c0ae03bf833c57e0ba1933f43e5cc"});new Gitalk(e).render("gitalk-container")}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Nyamori</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Makoto</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init({tocSelector:"#toc-body",contentSelector:".markdown-body",headingSelector:CONFIG.toc.headingSelector||"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:CONFIG.toc.collapseDepth||0,scrollSmooth:!0,headingsOffset:-o}),t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", "))}))</script><script>Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script>window.MathJax?(MathJax.startup.document.state(0),MathJax.texReset(),MathJax.typeset(),MathJax.typesetPromise()):window.MathJax={tex:{inlineMath:{"[+]":[["$","$"]]}},loader:{load:["ui/lazy"]},options:{renderActions:{insertedScript:[200,()=>{document.querySelectorAll("mjx-container").forEach(e=>{let t=e.parentNode;"li"===t.nodeName.toLowerCase()&&t.parentNode.classList.add("has-jax")})},"",!1]}}}</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>